<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç„¡é™å‹‡è€…ï¼šæ‰‹æ©Ÿé›™æ¬„ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #020617; 
            color: white; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            touch-action: manipulation;
        }

        .custom-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 0px; }

        .game-main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
        }

        /* å´é‚Šæ¬„ */
        .side-bar-left {
            width: 75px;
            display: flex;
            flex-direction: column;
            padding: 8px 4px;
            background: rgba(15, 23, 42, 0.9);
            border-right: 1px solid rgba(51, 65, 85, 0.5);
            gap: 10px;
        }

        .side-bar-right {
            width: 95px;
            display: flex;
            flex-direction: column;
            padding: 8px 4px;
            background: rgba(15, 23, 42, 0.9);
            border-left: 1px solid rgba(51, 65, 85, 0.5);
        }

        /* è£å‚™ 4x2 ç¶²æ ¼ */
        .equip-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }

        .equip-slot {
            width: 100%;
            aspect-ratio: 1/1.1;
            border: 1.5px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .rarity-ur { border-color: #ef4444; box-shadow: inset 0 0 8px rgba(239, 68, 68, 0.3); }
        .rarity-set { border-color: #22c55e; box-shadow: inset 0 0 8px rgba(34, 197, 94, 0.3); }

        /* åŸºå› å¼·åŒ– */
        .gene-btn {
            width: 100%;
            padding: 12px 2px;
            background: #1e293b;
            border-radius: 8px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .battle-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é£„å­— */
        .hit-effect {
            position: absolute; pointer-events: none; color: #ff4d4d; font-weight: 900; font-size: 2rem;
            animation: fly-up 0.7s ease-out forwards; z-index: 50; text-shadow: 2px 2px 0px #000;
        }
        @keyframes fly-up { 0% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -120px); } }

        /* é¸å–®æ‘ºç–Š */
        .foldable-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: #020617;
        }
        .foldable-menu.expanded { max-height: 75vh; }

        .btn-click:active { transform: scale(0.92); }
        .text-outline { text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
    </style>
</head>
<body>

    <!-- é ‚éƒ¨ç‹€æ…‹ -->
    <div class="h-16 bg-slate-950 flex justify-between items-center px-4 shrink-0 z-50 border-b border-slate-800">
        <div class="flex flex-col">
            <span class="text-[10px] text-slate-500 font-black">GOLD RESERVE</span>
            <span id="gold-display" class="text-yellow-400 font-black text-2xl leading-none">0</span>
        </div>
        <button onclick="showRebornModal()" class="bg-indigo-600 px-4 py-2 rounded-xl text-xs font-black btn-click border-b-4 border-indigo-800">
            è½‰ç”Ÿ <span id="reborn-count" class="text-indigo-200">0</span>
        </button>
    </div>

    <div class="game-main-container">
        <!-- å·¦æ¬„ï¼šåŸºå› å¼·åŒ– (ç›´åˆ—) -->
        <div class="side-bar-left custom-scroll">
            <div class="text-[10px] text-center font-black text-indigo-400 mb-2">GENE</div>
            <div id="gene-list" class="flex flex-col gap-4"></div>
        </div>

        <!-- ä¸­é–“ï¼šæˆ°é¬¥å€åŸŸ -->
        <div class="battle-center relative">
            <div class="absolute top-4 left-0 right-0 text-center z-10">
                <div id="zone-display" class="text-sm font-black text-white bg-indigo-900/60 border border-indigo-500/50 inline-block px-4 py-1.5 rounded-full backdrop-blur-md">Lv.1</div>
            </div>

            <div id="battle-scene" class="flex-1 flex flex-col items-center justify-center relative">
                <div id="monster-sprite" class="text-8xl mb-6 drop-shadow-[0_20px_20px_rgba(0,0,0,0.5)] transition-transform duration-75">ğŸ§Ÿ</div>
                <div id="monster-name" class="text-base font-black text-slate-300 mb-2">...</div>
                
                <!-- æ€ªç‰© HP -->
                <div class="relative w-48 h-5 bg-black/60 rounded-full border-2 border-slate-700 overflow-hidden mb-12 shadow-inner">
                    <div id="monster-hp-bar" class="h-full bg-gradient-to-r from-red-800 to-red-500 transition-all duration-100" style="width: 100%;"></div>
                    <div id="monster-hp-text" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-white text-outline">0 / 0</div>
                </div>

                <!-- ç©å®¶ç‹€æ…‹èˆ‡è‡ªå‹• -->
                <div class="absolute bottom-8 flex flex-col items-center gap-4 w-full">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] font-black text-blue-400 mb-1 uppercase tracking-widest">Player HP</span>
                        <div class="relative w-40 h-4 bg-black/60 rounded-full border-2 border-slate-800 overflow-hidden shadow-inner">
                            <div id="player-hp-bar" class="h-full bg-gradient-to-r from-blue-700 to-cyan-500 transition-all" style="width: 100%;"></div>
                            <div id="player-hp-text" class="absolute inset-0 flex items-center justify-center text-[9px] font-black text-white text-outline">0 / 0</div>
                        </div>
                    </div>
                    <button id="auto-btn" onclick="toggleAuto()" class="w-28 py-2.5 bg-slate-800 rounded-xl text-xs font-black border-2 border-slate-600 btn-click shadow-lg">è‡ªå‹•: OFF</button>
                </div>
            </div>
        </div>

        <!-- å³æ¬„ï¼šè£å‚™ (4x2 ç¶²æ ¼) -->
        <div class="side-bar-right custom-scroll">
            <div class="text-[10px] text-center font-black text-emerald-400 mb-2">EQUIP</div>
            <div id="equip-list" class="equip-grid"></div>
        </div>
    </div>

    <!-- åº•éƒ¨åŠŸèƒ½é¸å–® (åˆå§‹åŒ–æ‘ºç–Š) -->
    <div class="bg-slate-900 border-t-2 border-slate-800">
        <div onclick="toggleMenu()" class="h-14 flex items-center justify-between px-6 cursor-pointer bg-slate-950/50">
            <div class="flex items-center gap-4">
                <span class="text-sm font-black text-indigo-400 tracking-tighter">å‹‡è€…åŠŸèƒ½é¸å–®</span>
                <span id="gem-display" class="text-sm font-black text-emerald-300">ğŸ’ 0</span>
            </div>
            <div id="menu-arrow" class="text-indigo-400 transition-transform duration-300">â–²</div>
        </div>
        
        <div id="bottom-panel" class="foldable-menu custom-scroll">
            <div class="flex border-b border-slate-800 sticky top-0 bg-slate-900 z-20">
                <button onclick="switchTab('bag')" class="flex-1 py-5 text-xs font-black tab-btn" id="tab-bag">å‹‡è€…è¡Œå›Š</button>
                <button onclick="switchTab('shop')" class="flex-1 py-5 text-xs font-black tab-btn" id="tab-shop">è½‰ç”Ÿå•†åº—</button>
                <button onclick="switchTab('tower')" class="flex-1 py-5 text-xs font-black tab-btn text-purple-400" id="tab-tower">æ·±æ·µå‰¯æœ¬</button>
                <button onclick="showDoc()" class="flex-1 py-5 text-xs font-black text-slate-500">ç³»çµ±èªªæ˜</button>
            </div>
            <div id="tab-content" class="p-4 pb-24"></div>
        </div>
    </div>

    <!-- å½ˆçª— -->
    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-black/90 backdrop-blur-md">
        <div class="bg-slate-900 border-2 border-slate-700 rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div id="modal-header" class="p-5 bg-slate-800 font-black text-center text-base border-b border-slate-700"></div>
            <div id="modal-body" class="p-6 text-sm text-slate-300 custom-scroll max-h-[50vh]"></div>
            <div id="modal-footer" class="p-5 flex gap-3 bg-slate-900/50">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-700 rounded-2xl text-xs font-black btn-click">è¿”å›</button>
                <div id="modal-action" class="flex-1"></div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-24 left-1/2 -translate-x-1/2 w-4/5 z-[110] flex flex-col gap-3 pointer-events-none"></div>

    <script>
        const __app_id = "infinite_hero_pro_v3";

        // åš´æ ¼é™å®šæ€ªç‰©ç¨®é¡
        const MONSTERS = [
            { n: "éŠè•©æ®­å±", e: "ğŸ§Ÿ" }, { n: "éª¸éª¨å…µåœ˜", e: "ğŸ’€" }, { n: "å¸è¡€è™è ", e: "ğŸ¦‡" },
            { n: "é ‘å›ºçŸ³é ­æ€ª", e: "ğŸ—¿" }, { n: "å¤è€å·¨çŸ³åƒ", e: "ğŸ¤–" }, { n: "åŠ‡æ¯’å²©è›‡", e: "ğŸ" }
        ];

        const RARITIES = [
            { id: 'N', name: 'æ™®é€š', color: '#94a3b8', mult: 1, chance: 0.6 },
            { id: 'R', name: 'ç¨€æœ‰', color: '#3b82f6', mult: 3, chance: 0.25 },
            { id: 'SR', name: 'å²è©©', color: '#a855f7', mult: 8, chance: 0.1 },
            { id: 'SSR', name: 'å‚³å¥‡', color: '#f59e0b', mult: 20, chance: 0.04 },
            { id: 'UR', name: 'ç¥è©±', color: '#ef4444', mult: 50, chance: 0.01 },
            { id: 'SET', name: 'å¥—è£', color: '#22c55e', mult: 65, chance: 0 }
        ];

        const TYPES = ["é ­ç›”", "è­·ç”²", "è­·è…¿", "é´å­", "æ­¦å™¨", "ç›¾ç‰Œ", "é …éŠ", "æˆ’æŒ‡"];

        const DATA = {
            gold: 0, stones: 0, reborn: 0,
            level: 1, maxLevel: 1, towerFloor: 1,
            isTower: false, auto: false,
            stats: { str: 1, sta: 1, agi: 1 },
            costs: { str: 10, sta: 10, agi: 10 },
            equips: Array(8).fill(null),
            inv: [],
            shopLv: {},
            lastSave: Date.now()
        };

        const SHOP_ITEMS = [
            { id: 'dmg', n: 'æ··æ²Œæ­¦åŠ›', d: 'æœ€çµ‚å‚·å®³+50%', cost: 1 },
            { id: 'hp', n: 'è–å…‰ä¹‹è»€', d: 'æœ€çµ‚ç”Ÿå‘½+50%', cost: 1 },
            { id: 'def', n: 'é‡‘å‰›æ³•é«”', d: 'æœ€çµ‚æ¸›å‚·+30%', cost: 1 },
            { id: 'spd', n: 'ç¥é€Ÿç¥ç¶“', d: 'æ”»æ“Šé€Ÿåº¦+12%', cost: 2 },
            { id: 'critR', n: 'ç›´è¦ºæ•æ‰', d: 'æš´æ“Šç‡+6%', cost: 2 },
            { id: 'critD', n: 'å´©è£‚ä¹‹åŠ›', d: 'æš´æ“Šå‚·å®³+30%', cost: 2 },
            { id: 'blk', n: 'è­·èº«ç½¡æ°£', d: 'æ ¼æ“‹æ©Ÿç‡+4%', cost: 3 },
            { id: 'drop', n: 'å¹¸é‹çœ·é¡§', d: 'ç¨€æœ‰æ‰å¯¶+15%', cost: 3 },
            { id: 'gold', n: 'æ‹›è²¡è²“', d: 'é‡‘å¹£ç²å¾—+50%', cost: 2 },
            { id: 'setR', n: 'å¥—è£å…±é³´', d: 'å¥—è£æ‰ç‡+5%', cost: 5 },
            { id: 'rebP', n: 'è–çŸ³å‚³æ‰¿', d: 'è½‰ç”Ÿè–çŸ³+20%', cost: 8 },
            { id: 'baseH', n: 'é å¤ä¹‹è¡€', d: 'åŸºç¤ç”Ÿå‘½+1000', cost: 1 }
        ];

        let player = { hp: 100, maxHp: 100, dmg: 5, def: 0, spd: 1, blk: 0, cR: 0.05, cD: 1.5 };
        let enemy = null;
        let lastAtk = 0;
        let activeTab = 'bag';

        function f(n) {
            if (n < 1000) return Math.floor(n).toString();
            const units = ["K", "M", "B", "T", "P"];
            let u = -1;
            do { n /= 1000; u++; } while (n >= 1000 && u < units.length - 1);
            return n.toFixed(1) + units[u];
        }

        function init() {
            load();
            handleOffline();
            updateStats();
            spawn();
            switchTab('bag');
            requestAnimationFrame(loop);
            setInterval(save, 5000);
        }

        function handleOffline() {
            const now = Date.now();
            const diff = Math.floor((now - DATA.lastSave) / 1000);
            if (diff > 60) {
                const limit = Math.min(diff, 8 * 3600);
                const rate = DATA.maxLevel * 12 * (1 + (DATA.shopLv.gold || 0) * 0.5);
                const earned = Math.floor(rate * limit);
                DATA.gold += earned;
                showModal("â³ é›¢ç·šæ”¶ç›Šçµç®—", `
                    <div class="text-center py-4">
                        <p class="text-slate-500 mb-2">å‹‡è€…é›¢é–‹äº† ${Math.floor(limit/60)} åˆ†é˜</p>
                        <p class="text-4xl font-black text-yellow-400 mb-2">ğŸ’° ${f(earned)}</p>
                        <p class="text-[10px] text-slate-400">ç³»çµ±å·²æ ¹æ“šæ‚¨çš„æœ€é«˜é—œå¡è‡ªå‹•ç´¯è¨ˆæ”¶ç›Š</p>
                    </div>
                `);
            }
        }

        function loop(now) {
            if (enemy && enemy.hp > 0 && player.hp > 0 && (now - lastAtk >= (1000/player.spd))) {
                let isCrit = Math.random() < player.cR;
                let d = Math.max(1, Math.floor(player.dmg * (isCrit ? player.cD : 1)));
                enemy.hp -= d;
                showDmg(d, isCrit);
                
                if (enemy.hp <= 0) die();
                else {
                    let ed = Math.max(0, enemy.dmg - player.def);
                    if (Math.random() < player.blk) { ed = 0; toast("ğŸ›¡ï¸ å®Œå…¨æ ¼æ“‹", "#3b82f6"); }
                    player.hp = Math.max(0, player.hp - ed);
                    if (player.hp <= 0) pDie();
                }
                lastAtk = now;
                renderBars();
            }
            requestAnimationFrame(loop);
        }

        function spawn() {
            const floor = DATA.isTower ? DATA.towerFloor : DATA.level;
            const mult = DATA.isTower ? (Math.pow(2.2, floor) * 60) : Math.pow(1.32, floor-1);
            const m = MONSTERS[Math.floor(Math.random() * MONSTERS.length)];
            enemy = {
                name: DATA.isTower ? `[æ·±æ·µ] ${m.n}` : `${m.n} Lv.${floor}`,
                maxHp: Math.floor(180 * mult),
                dmg: Math.floor(25 * mult),
                gold: Math.floor(45 * mult),
                emoji: m.e
            };
            enemy.hp = enemy.maxHp;
            document.getElementById('monster-sprite').innerText = enemy.emoji;
            document.getElementById('monster-name').innerText = enemy.name;
            renderBars();
        }

        function die() {
            DATA.gold += Math.floor(enemy.gold * (1 + (DATA.shopLv.gold || 0) * 0.5));
            if (DATA.isTower || DATA.level % 10 === 0) drop();
            if (DATA.isTower) DATA.towerFloor++;
            else if (DATA.auto) { 
                DATA.level++; 
                if (DATA.level > DATA.maxLevel) DATA.maxLevel = DATA.level; 
            }
            player.hp = player.maxHp;
            updateUI(); 
            setTimeout(spawn, 300);
        }

        function pDie() {
            toast("ğŸ’€ æŒ‘æˆ°å¤±æ•—", "#ef4444");
            DATA.auto = false;
            if (DATA.isTower) { DATA.isTower = false; DATA.towerFloor = 1; }
            else if (DATA.level > 1) DATA.level--;
            player.hp = player.maxHp;
            updateUI(); setTimeout(spawn, 1000);
        }

        function updateStats() {
            const rb = Math.pow(1.65, DATA.reborn);
            const s = DATA.shopLv;
            
            let mHp = ((350 + (s.baseH||0) * 1000) + DATA.stats.sta * 120) * rb * (1 + (s.hp||0) * 0.5);
            let dmg = (18 + DATA.stats.str * 20) * rb * (1 + (s.dmg||0) * 0.5);
            let def = (DATA.stats.sta * 12) * rb * (1 + (s.def||0) * 0.3);
            let blk = Math.min(0.75, (DATA.stats.sta * 0.02) + (s.blk||0) * 0.04);
            let spd = (1 + (DATA.stats.agi * 0.09)) * (1 + (s.spd||0) * 0.12);
            let cR = 0.05 + (DATA.stats.agi * 0.018) + ((s.critR||0) * 0.06);
            let cD = 1.5 + (s.critD||0) * 0.3;

            let setCnt = 0;
            DATA.equips.forEach(e => { 
                if (e) { mHp += e.h; dmg += e.a; def += e.d; if (e.r === 'SET') setCnt++; } 
            });

            // å¥—è£å±¬æ€§å¯¦ä½œ
            if (setCnt >= 2) dmg *= 1.6;
            if (setCnt >= 4) mHp *= 2.0;
            if (setCnt >= 6) def *= 2.5;
            if (setCnt >= 8) cD += 2.5;

            player.maxHp = Math.floor(mHp);
            player.dmg = Math.floor(dmg);
            player.def = Math.floor(def);
            player.blk = blk; player.spd = spd; player.cR = cR; player.cD = cD;
            
            if (player.hp > player.maxHp || player.hp <= 0) player.hp = player.maxHp;
            renderEquips(); renderGenes();
        }

        function drop() {
            let r = null;
            const setRoll = (DATA.isTower ? 0.45 : 0.05) + ((DATA.shopLv.setR||0) * 0.05);
            if (Math.random() < setRoll) r = RARITIES.find(x => x.id === 'SET');
            else {
                let roll = Math.random(), cur = 0, m = 1 + ((DATA.shopLv.drop||0) * 0.15);
                for (const x of RARITIES) {
                    let c = x.chance * (x.id !== 'N' ? m : 1);
                    cur += c; if (roll < cur) { r = x; break; }
                }
            }
            if (!r) r = RARITIES[0];

            const idx = Math.floor(Math.random() * 8);
            const tier = Math.ceil((DATA.isTower ? DATA.towerFloor : DATA.level) / 10);
            const item = { 
                id: Math.random(), n: `${TYPES[idx]} T${tier}`, idx, r: r.id, 
                h: tier * 350 * r.mult, a: tier * 65 * r.mult, d: tier * 40 * r.mult 
            };

            if (r.id === 'SET') {
                DATA.inv.push(item);
                toast("ğŸŸ¢ ç²å¾—å¥—è£ï¼å·²å­˜å…¥èƒŒåŒ…", "#22c55e");
                if (activeTab === 'bag') switchTab('bag');
            } else {
                const old = DATA.equips[idx];
                const score = (i) => i ? (i.a * 6 + i.d * 4 + i.h / 15) : 0;
                if (score(item) > score(old)) {
                    DATA.equips[idx] = item;
                    updateStats();
                    toast(`âš”ï¸ ç©¿æˆ´: ${r.name}`, r.color);
                }
            }
        }

        function renderGenes() {
            const box = document.getElementById('gene-list'); box.innerHTML = '';
            const genes = [
                { id: 'str', n: 'æ­¦', c: '#ef4444' },
                { id: 'sta', n: 'é«”', c: '#3b82f6' },
                { id: 'agi', n: 'é€Ÿ', c: '#22c55e' }
            ];
            genes.forEach(g => {
                const div = document.createElement('div');
                div.className = 'gene-btn btn-click';
                div.onclick = () => {
                    if (DATA.gold >= DATA.costs[g.id]) {
                        DATA.gold -= DATA.costs[g.id]; DATA.stats[g.id]++;
                        DATA.costs[g.id] = Math.floor(DATA.costs[g.id] * 1.5);
                        updateStats(); updateUI();
                    } else toast("é‡‘å¹£ä¸è¶³", "#ef4444");
                };
                div.innerHTML = `
                    <span class="text-[12px] font-black" style="color:${g.c}">${g.n}</span>
                    <span class="text-[11px] font-black text-white">Lv.${DATA.stats[g.id]}</span>
                    <span class="text-[9px] font-black text-yellow-500">${f(DATA.costs[g.id])}</span>
                `;
                box.appendChild(div);
            });
        }

        function renderEquips() {
            const box = document.getElementById('equip-list'); box.innerHTML = '';
            TYPES.forEach((t, i) => {
                const eq = DATA.equips[i];
                const r = eq ? RARITIES.find(x => x.id === eq.r) : null;
                const div = document.createElement('div');
                div.className = `equip-slot ${eq?.r === 'UR' ? 'rarity-ur' : ''} ${eq?.r === 'SET' ? 'rarity-set' : ''}`;
                if (eq) {
                    div.style.borderColor = r.color;
                    div.innerHTML = `
                        <span class="text-[8px] font-black absolute top-1" style="color:${r.color}">${r.name}</span>
                        <span class="text-[12px] font-black text-white mt-2">âš”ï¸${f(eq.a)}</span>
                        <span class="text-[9px] font-black text-blue-400">â¤ï¸${f(eq.h)}</span>
                    `;
                } else {
                    div.innerHTML = `<span class="text-[10px] font-black text-slate-700">${t}</span>`;
                }
                box.appendChild(div);
            });
        }

        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-indigo-400', 'border-b-4', 'border-indigo-500'));
            document.getElementById(`tab-${t}`)?.classList.add('text-indigo-400', 'border-b-4', 'border-indigo-500');
            const box = document.getElementById('tab-content'); box.innerHTML = '';
            
            if (t === 'bag') {
                box.innerHTML = DATA.inv.map((it, i) => `
                    <div class="bg-slate-800 p-5 rounded-2xl mb-3 flex justify-between items-center border border-green-500/20 shadow-lg">
                        <div>
                            <div class="text-sm font-black text-white">${it.n} <span class="text-green-500 text-[10px]">[å¥—è£]</span></div>
                            <div class="text-xs text-slate-400 mt-1">âš”ï¸${f(it.a)} â¤ï¸${f(it.h)} ğŸ›¡ï¸${f(it.d)}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="equipInv(${i})" class="bg-green-700 px-4 py-3 rounded-xl text-xs font-black btn-click">ç©¿æˆ´</button>
                            <button onclick="delInv(${i})" class="bg-red-900/40 px-4 py-3 rounded-xl text-xs font-black btn-click">åˆ†è§£</button>
                        </div>
                    </div>
                `).join('') || '<div class="text-center py-20 text-slate-600 text-sm font-black">è¡Œå›Šä¸­å°šç„¡å¥—è£è£å‚™</div>';
            } else if (t === 'shop') {
                box.innerHTML = `<div class="grid grid-cols-1 gap-3">${SHOP_ITEMS.map(it => {
                    const lv = DATA.shopLv[it.id]||0, cost = it.cost + lv;
                    return `
                    <div class="bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-700 shadow-lg">
                        <div class="flex-1">
                            <div class="text-sm font-black text-indigo-300">${it.n} <span class="text-slate-500 text-[10px]">Lv.${lv}</span></div>
                            <div class="text-[10px] text-slate-400 mt-0.5">${it.d}</div>
                        </div>
                        <button onclick="buyShop('${it.id}')" class="bg-indigo-600 px-5 py-3 rounded-xl text-xs font-black btn-click ml-2">${cost} ğŸ’</button>
                    </div>`;
                }).join('')}</div>`;
            } else if (t === 'tower') {
                box.innerHTML = `
                    <div class="text-center py-12 bg-indigo-900/20 rounded-3xl border border-indigo-500/10">
                        <div class="text-purple-400 text-6xl mb-4 drop-shadow-lg">ğŸŒ€</div>
                        <div class="text-xl font-black text-white mb-2">æ·±æ·µå‰¯æœ¬æŒ‘æˆ°</div>
                        <p class="text-xs text-slate-400 mb-8 px-8 leading-relaxed">
                            é€™è£¡æ˜¯ç²å– <span class="text-green-500 font-black">å‚³å¥‡å¥—è£</span> çš„å”¯ä¸€ç¦åœ°ã€‚<br>
                            æ¯å±¤é›£åº¦ä»¥ <span class="text-purple-400 font-black">2.2 å€</span> æ¥µé€Ÿå¢é•·ã€‚<br>
                            å¤±æ•—å°‡æœƒé‡ç½®å±¤æ•¸ä¸¦å¼·åˆ¶é›¢é–‹ã€‚
                        </p>
                        <button onclick="startTower()" class="w-2/3 py-4 bg-purple-700 rounded-2xl text-sm font-black shadow-xl border-b-4 border-purple-900 btn-click">æŒ‘æˆ°æ·±æ·µ</button>
                    </div>`;
            }
        }

        function buyShop(id) {
            const it = SHOP_ITEMS.find(x => x.id === id);
            const cost = it.cost + (DATA.shopLv[id]||0);
            if (DATA.stones >= cost) {
                DATA.stones -= cost; DATA.shopLv[id] = (DATA.shopLv[id]||0) + 1;
                updateStats(); updateUI(); switchTab('shop'); toast("éˆé­‚å¥‘åˆæˆåŠŸ", "#a855f7");
            } else toast("è–çŸ³ä¸è¶³ï¼Œè«‹å¤šè½‰ç”Ÿ", "#ef4444");
        }

        function startTower() {
            DATA.isTower = true; DATA.towerFloor = 1; DATA.auto = false;
            toggleMenu(); updateUI(); spawn();
        }

        function equipInv(i) {
            const it = DATA.inv[i], old = DATA.equips[it.idx];
            DATA.equips[it.idx] = it; DATA.inv.splice(i, 1);
            if (old && old.r === 'SET') DATA.inv.push(old);
            updateStats(); switchTab('bag');
        }

        function delInv(i) { DATA.inv.splice(i, 1); switchTab('bag'); toast("è£å‚™å·²åˆ†è§£ç‚ºå¡µåœŸ", "#64748b"); }

        function showDoc() {
            showModal("ğŸ“œ å‹‡è€…ä¿®ç…‰æ‰‹å†Š", `
                <div class="space-y-6">
                    <div>
                        <p class="text-indigo-400 font-black text-base mb-2">ğŸ§¬ åŸºå› åºåˆ—èªªæ˜</p>
                        <p class="leading-relaxed">å·¦å´é¢æ¿å¯æ¶ˆè€—é‡‘å¹£å¼·åŒ–åŸºå› ã€‚<b>ã€æ­¦ã€‘</b>å½±éŸ¿æœ€çµ‚å‚·å®³ï¼›<b>ã€é«”ã€‘</b>å¢åŠ ç”Ÿå‘½èˆ‡é˜²ç¦¦ï¼›<b>ã€é€Ÿã€‘</b>æå‡æ”»é€Ÿèˆ‡æš´æ“Šã€‚</p>
                    </div>
                    <div>
                        <p class="text-green-500 font-black text-base mb-2">ğŸŸ¢ å¥—è£å…±é³´åŠ æˆ</p>
                        <ul class="space-y-1">
                            <li>â€¢ 2ä»¶ï¼šæœ€çµ‚å‚·å®³ <span class="text-white">+60%</span></li>
                            <li>â€¢ 4ä»¶ï¼šæœ€çµ‚ç”Ÿå‘½ <span class="text-white">+100%</span></li>
                            <li>â€¢ 6ä»¶ï¼šæ¸›å‚·æ•ˆç‡ <span class="text-white">+150%</span></li>
                            <li>â€¢ 8ä»¶ï¼šæš´æ“Šå‚·å®³ <span class="text-white">+250%</span></li>
                        </ul>
                    </div>
                    <div>
                        <p class="text-purple-400 font-black text-base mb-2">ğŸŒ€ æ·±æ·µæŒ‘æˆ°æ©Ÿåˆ¶</p>
                        <p>æ·±æ·µå‰¯æœ¬ä¸­çš„å¥—è£æ‰ç‡é«˜é” 45%ã€‚æ¯æŒ‘æˆ°æˆåŠŸä¸€å±¤ï¼Œæ€ªç‰©å¼·åº¦æå‡ 220%ï¼Œé€™æ˜¯æ¥µé™å‹‡è€…çš„è©¦ç…‰å ´ã€‚</p>
                    </div>
                </div>
            `);
        }

        function showRebornModal() {
            const s = Math.floor(DATA.maxLevel / 10 * (1 + (DATA.shopLv.rebP||0) * 0.2));
            showModal("âœ¨ éˆé­‚è½‰ç”Ÿ", `
                <div class="text-center py-4">
                    <p class="text-xs text-slate-500 mb-2 font-black">ç›®å‰æœ€é«˜é—œå¡ Lv.${DATA.maxLevel}</p>
                    <p class="text-[10px] text-slate-400 mb-4">æœ¬æ¬¡è½‰ç”Ÿå¯å‡èš</p>
                    <p class="text-5xl font-black text-indigo-400 mb-6">ğŸ’ ${s}</p>
                    <p class="text-xs text-slate-300 leading-relaxed bg-slate-800/50 p-4 rounded-2xl">
                        è½‰ç”Ÿå°‡é‡ç½®ç­‰ç´šèˆ‡é‡‘å¹£ï¼Œä½†æ‚¨çš„å±¬æ€§å°‡ç²å¾— <span class="text-white font-black">1.65 å€</span> çš„æ°¸ä¹…å¢å¹…ã€‚
                    </p>
                </div>
            `, DATA.maxLevel >= 100 ? `<button onclick="doReborn()" class="w-full py-4 bg-indigo-600 rounded-2xl text-sm font-black border-b-4 border-indigo-800 btn-click">ç«‹å³è½‰ç”Ÿ</button>` : `<div class="text-center py-2 text-red-500 font-black">éœ€é”åˆ° Lv.100 ä»¥ä¸Šæ‰å¯æ„Ÿæ‚Ÿè½‰ç”Ÿ</div>`);
        }

        function doReborn() {
            const s = Math.floor(DATA.maxLevel / 10 * (1 + (DATA.shopLv.rebP||0) * 0.2));
            DATA.stones += s; DATA.reborn++; DATA.level = 1; DATA.gold = 0; DATA.auto = false; DATA.isTower = false;
            updateStats(); updateUI(); closeModal(); spawn();
        }

        function toggleMenu() {
            const m = document.getElementById('bottom-panel'), i = document.getElementById('menu-arrow');
            const isEx = m.classList.toggle('expanded');
            i.style.transform = isEx ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function updateUI() {
            document.getElementById('gold-display').innerText = f(DATA.gold);
            document.getElementById('zone-display').innerText = DATA.isTower ? `ğŸŒ€ æ·±æ·µ ${DATA.towerFloor}F` : `ğŸ° é—œå¡ Lv.${DATA.level}`;
            document.getElementById('reborn-count').innerText = DATA.reborn;
            document.getElementById('gem-display').innerText = `ğŸ’ ${f(DATA.stones)}`;
            document.getElementById('auto-btn').innerText = `è‡ªå‹•: ${DATA.auto ? 'ON' : 'OFF'}`;
            document.getElementById('auto-btn').style.borderColor = DATA.auto ? '#6366f1' : '#475569';
        }

        function renderBars() {
            const pPct = (player.hp/player.maxHp*100);
            const ePct = (enemy.hp/enemy.maxHp*100);
            document.getElementById('player-hp-bar').style.width = pPct + '%';
            document.getElementById('monster-hp-bar').style.width = ePct + '%';
            document.getElementById('player-hp-text').innerText = `${f(player.hp)} / ${f(player.maxHp)}`;
            document.getElementById('monster-hp-text').innerText = `${f(enemy.hp)} / ${f(enemy.maxHp)}`;
        }

        function toggleAuto() { if (!DATA.isTower) { DATA.auto = !DATA.auto; updateUI(); } }

        function showDmg(a, c) {
            const el = document.createElement('div'); el.className = 'hit-effect';
            el.innerText = (c ? 'ğŸ’¥' : '') + f(a);
            const s = document.getElementById('battle-scene');
            el.style.left = '50%'; el.style.top = '40%';
            s.appendChild(el); setTimeout(() => el.remove(), 700);
        }

        function toast(m, c) {
            const t = document.createElement('div');
            t.className = 'p-4 rounded-2xl text-xs font-black text-white shadow-2xl text-center border-2 border-white/10 backdrop-blur-md';
            t.style.backgroundColor = c; t.innerText = m;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 2500);
        }

        function showModal(h, b, a) {
            document.getElementById('modal-header').innerHTML = h;
            document.getElementById('modal-body').innerHTML = b;
            document.getElementById('modal-action').innerHTML = a || "";
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function save() { DATA.lastSave = Date.now(); localStorage.setItem(__app_id, JSON.stringify(DATA)); }
        function load() {
            const s = localStorage.getItem(__app_id);
            if (s) {
                const p = JSON.parse(s);
                Object.keys(p).forEach(k => {
                    if (typeof p[k] === 'object' && !Array.isArray(p[k]) && p[k] !== null) Object.assign(DATA[k], p[k]);
                    else DATA[k] = p[k];
                });
            }
        }

        init();
    </script>
</body>
</html>
