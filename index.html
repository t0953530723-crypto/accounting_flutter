<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç„¡é™å‹‡è€…ï¼šåœ°åŸä¿®ç…‰ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root {
            --bg-dark: #020617;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: var(--bg-dark); 
            color: white; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
            overflow: hidden; 
            touch-action: manipulation;
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        .custom-scroll {
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* å…¨å±€å…§å®¹å±…ä¸­èˆ‡å­—é«”å¤§å° */
        .text-balanced { text-align: center; margin-left: auto; margin-right: auto; }
        
        /* è£å‚™æ¬„æ ¼å­ */
        .equip-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            width: 100%;
            padding: 16px;
            justify-items: center;
        }
        
        .equip-card {
            width: 80px;
            height: 95px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            background: rgba(30, 41, 59, 0.6);
            transition: all 0.2s;
        }

        /* åˆå§‹æ‘ºç–Šé‚è¼¯ */
        .foldable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(15, 23, 42, 0.8);
        }
        .foldable-content.expanded {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* å¼·åŒ–æ‰è½æ•¸å€¼å­—é«” */
        .stat-text { font-size: 1.1rem; font-weight: 900; line-height: 1.2; text-align: center; }
        .rarity-ur { box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); border-color: #ef4444 !important; }
        .rarity-set { box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); border-color: #22c55e !important; }

        /* æˆ°é¬¥é£„å­— */
        .hit-effect {
            position: absolute; pointer-events: none; color: #f87171; font-weight: 900; font-size: 2.5rem;
            animation: fly-up 0.8s ease-out forwards; z-index: 50; text-shadow: 2px 2px 4px #000;
        }
        @keyframes fly-up { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }

        .tab-btn { flex: 1; padding: 16px 0; font-size: 1.1rem; font-weight: 900; color: #94a3b8; border-bottom: 4px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: #6366f1; background: rgba(51, 65, 85, 0.4); }

        .btn-main { @apply active:scale-95 transition-transform; cursor: pointer; }
    </style>
</head>
<body class="custom-scroll">

    <!-- é ‚éƒ¨è³‡æºåˆ— -->
    <div class="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center shrink-0">
        <div class="flex flex-col items-center">
            <span class="text-[10px] text-slate-500 font-black uppercase">GOLD</span>
            <span id="gold-display" class="text-yellow-400 font-black text-2xl">0</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="mode-badge" class="px-3 py-0.5 rounded-full text-[10px] font-black bg-slate-800 text-slate-400 mb-1">åœ°åŸæ¢éšª</div>
            <span id="zone-display" class="text-xl font-black text-white">Lv.1</span>
        </div>
        <button onclick="showRebornDetails()" class="bg-indigo-600 px-5 py-2 rounded-2xl text-base font-black shadow-lg btn-main">
            è½‰ç”Ÿ
            <div id="reborn-status" class="text-[10px] opacity-80">x0</div>
        </button>
    </div>

    <!-- æˆ°é¬¥å€åŸŸ -->
    <div id="battle-scene" class="relative flex-1 bg-slate-900 flex flex-col items-center justify-center overflow-hidden min-h-[350px]">
        <div id="monster-container" class="flex flex-col items-center w-full px-4">
            <div id="monster-sprite" class="text-[130px] mb-4 select-none drop-shadow-2xl transition-transform active:scale-90">ğŸ§Ÿ</div>
            <div id="monster-name" class="text-3xl font-black mb-4 text-slate-100">è¼‰å…¥ä¸­...</div>
            <div class="w-full max-w-[300px] h-7 bg-black rounded-full border-2 border-slate-700 overflow-hidden shadow-inner relative">
                <div id="monster-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-rose-500 transition-all duration-100" style="width: 100%;"></div>
            </div>
            
            <div class="flex gap-4 mt-10">
                <button onclick="toggleAuto()" id="auto-btn" class="bg-slate-700 px-8 py-4 rounded-2xl text-lg font-black border-2 border-white/10 shadow-2xl btn-main">è‡ªå‹•: OFF</button>
                <button onclick="goBack()" class="bg-slate-800 px-8 py-4 rounded-2xl text-lg font-black border-2 border-slate-700 shadow-2xl btn-main">æ’¤é€€</button>
            </div>
        </div>

        <!-- å‹‡è€…ç‹€æ…‹ -->
        <div class="absolute bottom-8 left-10 right-10">
            <div class="flex justify-between text-xs font-black text-blue-400 mb-1 uppercase">
                <span>Player Vitality</span>
                <span id="player-hp-text">0 / 0</span>
            </div>
            <div class="w-full h-5 bg-black rounded-full overflow-hidden border-2 border-slate-800">
                <div id="player-hp-bar" class="h-full bg-blue-500 transition-all duration-200" style="width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- è£å‚™é¢æ¿ (åˆå§‹æ‘ºç–Š) -->
    <div class="bg-slate-950 border-t-2 border-slate-800 shrink-0">
        <div onclick="toggleFold('equip-content', 'fold-icon-equip')" class="py-5 px-8 flex justify-between items-center cursor-pointer hover:bg-slate-900 transition-colors">
            <span class="text-sm font-black text-slate-400 uppercase tracking-widest">å‹‡è€…è£å‚™æ¬„ (é»æ“Šå±•é–‹)</span>
            <div id="fold-icon-equip" class="text-slate-500 font-bold">â–²</div>
        </div>
        <div id="equip-content" class="foldable-content">
            <div id="equipment-slots" class="equip-grid-container">
                <!-- 8æ ¼è£å‚™ JSå¡«å…… -->
            </div>
            <div id="set-bonus-display" class="px-8 pb-5 text-sm font-black text-green-400 text-center leading-relaxed"></div>
        </div>
    </div>

    <!-- åŠŸèƒ½é¸å–® (åˆå§‹æ‘ºç–Š) -->
    <div class="bg-slate-950 border-t-2 border-slate-800 flex flex-col shrink-0">
        <div onclick="toggleFold('menu-content', 'fold-icon-menu')" class="py-5 px-8 flex justify-between items-center cursor-pointer hover:bg-slate-900 transition-colors">
            <span class="text-sm font-black text-indigo-400 uppercase tracking-widest">æ ¸å¿ƒé¸å–® (é»æ“Šå±•é–‹)</span>
            <div id="fold-icon-menu" class="text-indigo-400 font-bold">â–²</div>
        </div>
        
        <div id="menu-content" class="foldable-content">
            <div class="flex bg-slate-950 border-b border-slate-800">
                <button onclick="switchTab('upgrade')" id="btn-upgrade" class="tab-btn active">åŸºå› å¼·åŒ–</button>
                <button onclick="switchTab('bag')" id="btn-bag" class="tab-btn">è¡Œå›Š</button>
                <button onclick="switchTab('tower')" id="btn-tower" class="tab-btn text-purple-400">æ·±æ·µå‰¯æœ¬</button>
                <button onclick="switchTab('shop')" id="btn-shop" class="tab-btn">è–çŸ³å•†åº—</button>
            </div>
            <div id="tab-content" class="h-[320px] overflow-y-auto p-5 custom-scroll bg-slate-900/40">
                <!-- å…§å®¹ç”± JS å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- å½ˆçª—ç³»çµ± -->
    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-black/90 backdrop-blur-md">
        <div class="bg-slate-900 border-2 border-slate-700 rounded-3xl w-full max-w-sm overflow-hidden flex flex-col shadow-2xl">
            <div id="modal-header" class="p-6 bg-slate-800 font-black text-xl border-b-2 border-slate-700 text-center uppercase tracking-wider"></div>
            <div id="modal-body" class="p-7 text-balanced text-slate-300 custom-scroll max-h-[50vh] leading-relaxed"></div>
            <div id="modal-footer" class="p-6 flex gap-4 border-t border-slate-800">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-700 rounded-2xl font-black btn-main">è¿”å›</button>
                <div id="modal-action" class="flex-1"></div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-28 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <script>
        const __app_id = "infinite_hero_zen_v4";
        
        // æŒ‡å®šæ€ªç‰©æ± 
        const MONSTER_POOL = [
            { n: "è…çˆ›æ®­å±", e: "ğŸ§Ÿ" }, { n: "æ¯éª¨æˆ°å£«", e: "ğŸ’€" }, { n: "å¸è¡€è™è ", e: "ğŸ¦‡" },
            { n: "é ‘å›ºçŸ³é ­æ€ª", e: "ğŸ—¿" }, { n: "é å¤å·¨çŸ³åƒ", e: "ğŸ¤–" }, { n: "åœ°åº•æ¯’è›‡", e: "ğŸ" }
        ];

        const GAME_DATA = {
            gold: 0, rebornStones: 0, rebornCount: 0,
            level: 1, maxLevel: 1,
            autoAdv: false, isTower: false, towerFloor: 1,
            stats: { str: 1, sta: 1, agi: 1 },
            costs: { str: 10, sta: 10, agi: 10 },
            equips: Array(8).fill(null),
            inv: [],
            shopLv: { dmg:0, hp:0, def:0, spd:0, critR:0, drop:0, gold:0, critD:0, block:0, setR:0, rebP:0, hP:0 },
            lastSave: Date.now()
        };

        const SHOP_ITEMS = [
            { id: 'dmg', n: 'ç ´å£ä¹‹åŠ›', d: 'æœ€çµ‚å‚·å®³ +50%', baseCost: 1 },
            { id: 'hp', n: 'ç”Ÿå‘½æ³‰æº', d: 'æœ€å¤§ç”Ÿå‘½ +50%', baseCost: 1 },
            { id: 'def', n: 'é‹¼éµæ„å¿—', d: 'é˜²ç¦¦æ•ˆæœ +30%', baseCost: 1 },
            { id: 'spd', n: 'è¿…æ·è…³æ­¥', d: 'æ”»æ“Šé€Ÿåº¦ +10%', baseCost: 2 },
            { id: 'critR', n: 'ç²¾ç¢ºæ‰“æ“Š', d: 'æš´æ“Šæ©Ÿç‡ +5%', baseCost: 2 },
            { id: 'critD', n: 'è‡´å‘½ä¸€æ“Š', d: 'æš´æ“Šå‚·å®³ +20%', baseCost: 2 },
            { id: 'block', n: 'ç¥è–æ ¼æ“‹', d: 'æ ¼æ“‹æ©Ÿç‡ +2% (ä¸Šé™70%)', baseCost: 3 },
            { id: 'drop', n: 'å°‹å¯¶é”äºº', d: 'è£å‚™æ‰è½ç‡ +10%', baseCost: 3 },
            { id: 'gold', n: 'è²¡å¯Œå¢å¹…', d: 'é‡‘å¹£ç²å¾— +50%', baseCost: 2 },
            { id: 'setR', n: 'å¥—è£å…±é³´', d: 'å¥—è£å‡ºç¾æ©Ÿç‡ +5%', baseCost: 5 },
            { id: 'rebP', n: 'å‘½é‹å›é¥‹', d: 'è½‰ç”ŸçŸ³æ•¸é‡ +10%', baseCost: 10 },
            { id: 'hP', n: 'åŸå§‹é«”è³ª', d: 'åŸºç¤ç”Ÿå‘½å€¼ +200', baseCost: 1 }
        ];

        const TYPES = ["é ­ç›”", "è­·ç”²", "è­·è…¿", "é´å­", "æ­¦å™¨", "ç›¾ç‰Œ", "é …éŠ", "æˆ’æŒ‡"];
        const RARITIES = [
            { id: 'N', name: 'æ™®é€š', color: '#94a3b8', chance: 0.6, mult: 1 },
            { id: 'R', name: 'ç¨€æœ‰', color: '#3b82f6', chance: 0.25, mult: 2.2 },
            { id: 'SR', name: 'å²è©©', color: '#a855f7', chance: 0.1, mult: 4.5 },
            { id: 'SSR', name: 'å‚³å¥‡', color: '#f59e0b', chance: 0.04, mult: 9 },
            { id: 'UR', name: 'ç¥è©±', color: '#ef4444', chance: 0.01, mult: 20 },
            { id: 'SET', name: 'å¥—è£', color: '#22c55e', chance: 0, mult: 22.0 }
        ];

        let player = { hp: 100, maxHp: 100, dmg: 5, def: 0, block: 0, spd: 1, critR: 0.05, critD: 1.5 };
        let enemy = null;
        let lastAtk = 0;
        let activeTab = 'upgrade';

        // æ ¼å¼åŒ–æ•¸å­—é˜²æ­¢é€šè†¨é¡¯ç¤º
        function formatNumber(n) {
            if (n < 1000) return Math.floor(n).toString();
            const units = ["K", "M", "B", "T", "P", "E"];
            let unitIdx = -1;
            let val = n;
            while (val >= 1000 && unitIdx < units.length - 1) {
                val /= 1000;
                unitIdx++;
            }
            return val.toFixed(unitIdx === -1 ? 0 : 1) + (unitIdx === -1 ? "" : units[unitIdx]);
        }

        function init() {
            loadGame();
            handleOfflineIncome();
            updateStats();
            spawn();
            switchTab('upgrade');
            gameLoop();
            setInterval(saveGame, 5000);
        }

        function handleOfflineIncome() {
            const now = Date.now();
            const diffSeconds = Math.floor((now - GAME_DATA.lastSave) / 1000);
            if (diffSeconds > 60) {
                const incomePerSec = Math.floor(GAME_DATA.maxLevel * 3 * (1 + GAME_DATA.shopLv.gold * 0.5));
                const maxSeconds = 12 * 3600; // æœ€å¤šç´¯è¨ˆ 12 å°æ™‚
                const effectiveTime = Math.min(diffSeconds, maxSeconds);
                const totalGold = incomePerSec * effectiveTime;
                GAME_DATA.gold += totalGold;
                
                showModal("é›¢ç·šçµç®—å›å ±", `
                    <div class="space-y-5 py-4">
                        <p class="text-slate-400 font-bold">æ‚¨å·²ç¶“é›¢é–‹å†’éšªæ—…ç¨‹ ${Math.floor(effectiveTime / 60)} åˆ†é˜</p>
                        <p class="text-4xl font-black text-yellow-400 tracking-widest">ğŸ’° ${formatNumber(totalGold)}</p>
                        <div class="text-[11px] text-slate-500 bg-black/30 p-3 rounded-xl">
                            è¨ˆç®—å…¬å¼ï¼šæœ€é«˜å±¤æ•¸ (${GAME_DATA.maxLevel}) Ã— æ”¶ç›ŠåŠ æˆ Ã— é›¢ç·šæ™‚é•·
                        </div>
                    </div>
                `);
            }
        }

        function gameLoop() {
            const now = Date.now();
            if (enemy && enemy.hp > 0 && player.hp > 0 && (now - lastAtk >= (1000/player.spd))) {
                performAttack();
                lastAtk = now;
            }
            requestAnimationFrame(gameLoop);
        }

        function performAttack() {
            let isCrit = Math.random() < player.critR;
            let d = Math.max(1, Math.floor(player.dmg * (isCrit ? player.critD : 1)));
            enemy.hp -= d;
            updateEnemyUI();
            showDmg(d, isCrit);
            
            if (enemy.hp <= 0) { die(); return; }

            let ed = Math.max(0, enemy.dmg - player.def);
            if (Math.random() < player.block) { ed = 0; toast("ğŸ›¡ï¸ æ ¼æ“‹é˜²ç¦¦æˆåŠŸï¼", "#60a5fa"); }
            player.hp = Math.max(0, player.hp - ed);
            updatePlayerUI();
            if (player.hp <= 0) pDie();
        }

        function spawn() {
            const floor = GAME_DATA.isTower ? GAME_DATA.towerFloor : GAME_DATA.level;
            // å‰¯æœ¬é›£åº¦åŠ å¼·
            const baseScale = Math.pow(1.23, floor - 1);
            const towerScale = GAME_DATA.isTower ? (Math.pow(1.4, floor) * 10) : 1;
            const finalScale = baseScale * towerScale;

            const monster = MONSTER_POOL[Math.floor(Math.random() * MONSTER_POOL.length)];
            
            enemy = {
                name: GAME_DATA.isTower ? `[æ·±æ·µ] ${monster.n} ${floor}F` : `${monster.n} Lv.${floor}`,
                maxHp: Math.floor(70 * finalScale),
                dmg: Math.floor(12 * finalScale),
                gold: Math.floor(15 * finalScale),
                emoji: monster.e
            };
            enemy.hp = enemy.maxHp;
            renderEnemy();
        }

        function renderEnemy() {
            document.getElementById('monster-sprite').innerText = enemy.emoji;
            document.getElementById('monster-name').innerText = enemy.name;
            updateEnemyUI();
        }

        function updateEnemyUI() {
            const p = (Math.max(0, enemy.hp) / enemy.maxHp) * 100;
            document.getElementById('monster-hp-bar').style.width = p + "%";
        }

        function die() {
            GAME_DATA.gold += Math.floor(enemy.gold * (1 + GAME_DATA.shopLv.gold * 0.5));
            if (GAME_DATA.isTower || (GAME_DATA.level % 10 === 0)) dropItem();
            
            if (GAME_DATA.isTower) { 
                GAME_DATA.towerFloor++; 
            } else if (GAME_DATA.autoAdv) { 
                GAME_DATA.level++; 
                if (GAME_DATA.level > GAME_DATA.maxLevel) GAME_DATA.maxLevel = GAME_DATA.level; 
            }
            
            player.hp = player.maxHp;
            updateUI(); updatePlayerUI(); setTimeout(spawn, 300);
            saveGame();
        }

        function pDie() {
            toast("ğŸ’” å†’éšªä¸­æ–·ä¸¦æ’¤é€€...", "#ef4444");
            GAME_DATA.autoAdv = false;
            if (GAME_DATA.isTower) { 
                GAME_DATA.isTower = false; 
                GAME_DATA.towerFloor = 1; 
                document.getElementById('battle-scene').style.backgroundColor = '';
            } else if (GAME_DATA.level > 1) { 
                GAME_DATA.level--; 
            }
            player.hp = player.maxHp;
            updateUI(); updatePlayerUI(); setTimeout(spawn, 1000);
        }

        function updateStats() {
            const rb = Math.pow(1.5, GAME_DATA.rebornCount);
            const s = GAME_DATA.shopLv;
            
            // åŸºç¤æ•¸å€¼è¨ˆç®— (åŒ…å«è–çŸ³å¼·åŒ–)
            let maxHp = Math.floor(((100 + s.hP * 200) + GAME_DATA.stats.str * 50) * rb * (1 + s.hp * 0.5));
            let dmg = Math.floor((6 + GAME_DATA.stats.str * 7) * rb * (1 + s.dmg * 0.5));
            let def = Math.floor((GAME_DATA.stats.sta * 5) * rb * (1 + s.def * 0.3));
            let block = Math.min(0.7, (GAME_DATA.stats.sta * 0.015) + s.block * 0.02);
            let spd = (1 + (GAME_DATA.stats.agi * 0.08)) * (1 + s.spd * 0.1);
            let critR = 0.05 + (GAME_DATA.stats.agi * 0.008) + (s.critR * 0.05);
            let critD = 1.5 + s.critD * 0.2;

            // è£å‚™åŸºç¤åŠ æˆ
            let setCount = 0;
            GAME_DATA.equips.forEach(e => { 
                if (e) { 
                    maxHp += e.h; dmg += e.a; def += e.d; 
                    if (e.r === 'SET') setCount++;
                } 
            });

            // å¥—è£å±¬æ€§åŠ æˆå¯¦ä½œ
            let setBonusText = [];
            if (setCount >= 2) { dmg *= 1.3; setBonusText.push("2ä»¶: å‚·å®³+30%"); }
            if (setCount >= 4) { maxHp *= 1.6; setBonusText.push("4ä»¶: ç”Ÿå‘½+60%"); }
            if (setCount >= 6) { def *= 2.0; setBonusText.push("6ä»¶: é˜²ç¦¦+100%"); }
            if (setCount >= 8) { critD += 1.2; setBonusText.push("8ä»¶: æš´å‚·+120%"); }

            player.maxHp = Math.floor(maxHp);
            player.dmg = Math.floor(dmg);
            player.def = Math.floor(def);
            player.block = block;
            player.spd = spd;
            player.critR = critR;
            player.critD = critD;
            
            if (player.hp > player.maxHp || player.hp <= 0) player.hp = player.maxHp;
            
            document.getElementById('set-bonus-display').innerText = setBonusText.join(" | ") || "ç›®å‰ç„¡å¥—è£åŠ æˆæ•ˆæœ";
            updatePlayerUI(); renderEquips();
        }

        function renderEquips() {
            const container = document.getElementById('equipment-slots');
            container.innerHTML = '';
            TYPES.forEach((type, i) => {
                const eq = GAME_DATA.equips[i];
                const rarity = eq ? RARITIES.find(r => r.id === eq.r) : null;
                const div = document.createElement('div');
                div.className = `equip-card ${eq?.r === 'UR' ? 'rarity-ur' : ''} ${eq?.r === 'SET' ? 'rarity-set' : ''}`;
                if (eq) {
                    div.style.borderColor = rarity.color;
                    div.innerHTML = `
                        <span class="text-[10px] font-black uppercase" style="color:${rarity.color}">${rarity.name}</span>
                        <div class="flex flex-col items-center mt-1">
                            <span class="stat-text text-red-400">æ”»:${formatNumber(eq.a)}</span>
                            <span class="stat-text text-blue-400">è¡€:${formatNumber(eq.h)}</span>
                        </div>`;
                } else {
                    div.innerHTML = `<span class="text-[11px] font-black text-slate-600">${type}</span>`;
                }
                container.appendChild(div);
            });
        }

        function dropItem() {
            let r = null;
            const setChance = 0.25 + (GAME_DATA.shopLv.setR * 0.05);
            // å‰¯æœ¬ä¿è­‰é«˜æ©Ÿç‡ç”¢å‡ºå¥—è£
            if (GAME_DATA.isTower && Math.random() < setChance) { 
                r = RARITIES.find(x => x.id === 'SET'); 
            } else {
                let roll = Math.random();
                let cur = 0;
                let dropMult = 1 + (GAME_DATA.shopLv.drop * 0.1);
                for (const x of RARITIES) {
                    let c = x.chance * (x.id !== 'N' ? dropMult : 1);
                    cur += c; 
                    if (roll < cur) { r = x; break; }
                }
            }

            if (r) {
                const idx = Math.floor(Math.random() * 8);
                const tier = Math.ceil((GAME_DATA.isTower ? GAME_DATA.towerFloor : GAME_DATA.level) / 10);
                const item = { 
                    id: Math.random(), 
                    n: `${TYPES[idx]} T${tier}`, 
                    idx, r: r.id, tier, 
                    h: tier*110*r.mult, 
                    a: tier*22*r.mult, 
                    d: tier*11*r.mult 
                };
                
                if (r.id === 'SET') {
                    if (GAME_DATA.inv.length < 32) { 
                        GAME_DATA.inv.push(item); 
                        toast("ğŸŸ¢ ç²å¾—å¥—è£ï¼šå·²å³æ™‚é€åˆ°è¡Œå›Šï¼", "#22c55e"); 
                        if (activeTab === 'bag') switchTab('bag'); 
                    } else {
                        toast("âŒ è¡Œå›Šç©ºé–“ä¸è¶³ï¼", "#ef4444");
                    }
                } else {
                    const current = GAME_DATA.equips[idx];
                    const score = (i) => i ? (i.a*12 + i.d*10 + i.h/3) : 0;
                    if (score(item) > score(current)) { 
                        GAME_DATA.equips[idx] = item; 
                        updateStats(); 
                        toast("ğŸ›¡ï¸ è‡ªå‹•æ›è£ï¼šæˆ°åŠ›æå‡", "#3b82f6"); 
                    }
                }
            }
        }

        function toggleFold(targetId, iconId) {
            const content = document.getElementById(targetId);
            const icon = document.getElementById(iconId);
            const isExpanded = content.classList.toggle('expanded');
            icon.innerText = isExpanded ? 'â–¼' : 'â–²';
        }

        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${t}`).classList.add('active');
            
            const content = document.getElementById('tab-content');
            content.innerHTML = '';
            
            if (t === 'upgrade') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-5 px-1">
                        <span class="text-xs font-black text-slate-500 uppercase tracking-widest">åŸºå› å¼·åŒ–ç³»çµ±</span>
                        <button onclick="showDetail('attr')" class="text-xs text-indigo-400 font-black">è©³ç´°èªªæ˜</button>
                    </div>
                    <div class="space-y-4">
                        ${renderUp('æ”»æ“ŠåŸºå›  (STR)', 'str', 'æ”»æ“Š+7, ç”Ÿå‘½+50', '#ef4444')}
                        ${renderUp('ç”Ÿå­˜åŸºå›  (STA)', 'sta', 'é˜²ç¦¦+5, æå‡æ ¼æ“‹', '#3b82f6')}
                        ${renderUp('è¶…é »åŸºå›  (AGI)', 'agi', 'é€Ÿ+8%, æå‡æš´æ“Š', '#22c55e')}
                    </div>`;
            } else if (t === 'bag') {
                content.innerHTML = `
                    <div class="text-xs text-slate-500 mb-5 font-black text-center uppercase">å¥—è£æ”¶è—ç›¤é» (${GAME_DATA.inv.length}/32)</div>
                    <div class="grid grid-cols-1 gap-4">
                        ${GAME_DATA.inv.map((item, i) => `
                            <div class="bg-slate-800 border-2 border-green-600 rounded-2xl p-4 flex justify-between items-center rarity-set">
                                <div class="text-left flex-1" onclick="equipFromInv(${i})">
                                    <p class="text-xl font-black text-white">${item.n}</p>
                                    <p class="text-[13px] text-slate-400 font-bold">æ”»:${formatNumber(item.a)} | è¡€:${formatNumber(item.h)} | é˜²:${formatNumber(item.d)}</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="equipFromInv(${i})" class="bg-green-700 px-4 py-2 rounded-xl text-xs font-black">ç©¿æˆ´</button>
                                    <button onclick="deleteFromInv(${i})" class="bg-red-900/60 px-4 py-2 rounded-xl text-xs font-black text-red-200">åˆ†è§£</button>
                                </div>
                            </div>`).join('')}
                    </div>
                    ${GAME_DATA.inv.length === 0 ? '<div class="py-16 text-slate-600 font-black">ç›®å‰æ²’æœ‰æ”¶è—ä»»ä½•å¥—è£</div>' : ''}`;
            } else if (t === 'shop') {
                content.innerHTML = `
                    <div class="bg-indigo-950 p-5 rounded-2xl border border-indigo-500/30 mb-6 flex justify-between items-center">
                        <span class="text-3xl font-black text-white">ğŸ’ ${GAME_DATA.rebornStones}</span>
                        <span class="text-[11px] text-indigo-400 font-black uppercase tracking-widest">å¯ç”¨è–çŸ³</span>
                    </div>
                    <div class="space-y-4">${SHOP_ITEMS.map(i => renderShop(i)).join('')}</div>`;
            } else if (t === 'tower') {
                showDetail('tower');
            }
        }

        function renderUp(n, k, d, c) {
            return `<div class="bg-slate-800 p-5 rounded-2xl flex justify-between items-center border border-slate-700">
                <div class="text-left"><p class="text-lg font-black" style="color:${c}">${n} Lv.${GAME_DATA.stats[k]}</p><p class="text-[12px] text-slate-500">${d}</p></div>
                <button onclick="upStat('${k}')" class="bg-slate-900 px-6 py-3 rounded-xl text-sm font-black text-yellow-400 btn-main">ğŸ’° ${formatNumber(GAME_DATA.costs[k])}</button>
            </div>`;
        }

        function renderShop(item) {
            const lv = GAME_DATA.shopLv[item.id] || 0;
            const cost = item.baseCost + lv;
            return `<div class="bg-slate-800 p-5 rounded-2xl flex justify-between items-center border border-slate-700">
                <div class="text-left flex-1 pr-4"><p class="text-lg font-black text-white">${item.n} [${lv}]</p><p class="text-[11px] text-slate-500">${item.d}</p></div>
                <button onclick="buyShop('${item.id}')" class="bg-indigo-900 px-5 py-3 rounded-xl text-sm font-black text-white btn-main">${cost} ğŸ’</button>
            </div>`;
        }

        function showDetail(type) {
            if (type === 'attr') {
                showModal("å±¬æ€§èƒ½åŠ›è©³ç´°èªªæ˜", `
                    <div class="text-left space-y-5 text-sm">
                        <div class="border-l-4 border-red-500 pl-4"><strong class="text-red-400 text-lg block">åŠ›é‡ (STR)</strong>æ¯ç´š +7 æ”»æ“Š, +50 ç”Ÿå‘½ã€‚è½‰ç”Ÿå¾Œå€ç‡æå‡æœ€æ˜é¡¯çš„æ ¸å¿ƒå±¬æ€§ã€‚</div>
                        <div class="border-l-4 border-blue-500 pl-4"><strong class="text-blue-400 text-lg block">ç”Ÿå­˜ (STA)</strong>æ¯ç´š +5 é˜²ç¦¦, ä¸¦æä¾›æ ¼æ“‹æ©Ÿç‡ã€‚é˜²ç¦¦å¯ç›´æ¥æŠµéŠ·æ•µå‚·ï¼Œæ ¼æ“‹å¯å®Œå…¨å…ç–«è©²æ¬¡æ”»æ“Šã€‚</div>
                        <div class="border-l-4 border-green-500 pl-4"><strong class="text-green-400 text-lg block">è¶…é » (AGI)</strong>æ¯ç´š +8% æ”»é€Ÿèˆ‡å›ºå®šæš´æ“Šç‡ã€‚æ”»é€Ÿç›´æ¥ç¸®çŸ­æ”»æ“Šé–“éš”ã€‚</div>
                        <p class="text-[11px] text-slate-500 pt-3 border-t border-slate-800">æ•¸å€¼å…¬å¼ï¼š(åŸºç¤ + ç­‰ç´šÃ—æˆé•·) Ã— è½‰ç”Ÿå€ç‡ Ã— è£å‚™åŠ æˆ</p>
                    </div>
                `);
            } else if (type === 'tower') {
                showModal("æ·±æ·µç¦åœ°å‰¯æœ¬èªªæ˜", `
                    <div class="space-y-5 text-left text-sm">
                        <div class="bg-purple-900/30 p-5 rounded-2xl border border-purple-700/50">
                            <p class="text-purple-300 font-black mb-2 text-lg">âš ï¸ æ¥µé™é›£åº¦</p>
                            <p class="text-slate-300">å‰¯æœ¬æ€ªç‰©çš„ç”Ÿå‘½èˆ‡æ”»æ“Šæ˜¯åœ°åŸçš„ 10 å€ä»¥ä¸Šï¼Œä¸”æ¯å±¤å¢åŠ  40%ã€‚ä¸€æ—¦æŒ‘æˆ°å¤±æ•—ï¼Œå‰¯æœ¬é€²åº¦å°‡æœƒé‡ç½®ã€‚</p>
                        </div>
                        <div class="bg-green-900/30 p-5 rounded-2xl border border-green-700/50">
                            <p class="text-green-300 font-black mb-2 text-lg">ğŸ›¡ï¸ å‚³èªªå¥—è£</p>
                            <p class="text-slate-300">é€™æ˜¯ç²å¾—ã€Œç¶ è‰²å¥—è£ã€çš„å”¯ä¸€é€”å¾‘ã€‚æ”¶é›† 2/4/6/8 ä»¶å¯ç²å¾—æ¥µå…¶å¼·å¤§çš„å…¨èƒ½åŠ›ç¿»å€æ•ˆæœã€‚</p>
                        </div>
                    </div>`, 
                    `<button onclick="toggleTower();closeModal()" class="w-full py-4 bg-purple-600 rounded-2xl font-black shadow-xl">æŒ‘æˆ°æ·±æ·µ</button>`
                );
            }
        }

        function showRebornDetails() {
            const stone = Math.floor(GAME_DATA.maxLevel / 10 * (1 + GAME_DATA.shopLv.rebP * 0.1));
            showModal("å¤è€è½‰ç”Ÿå„€å¼èªªæ˜", `
                <div class="text-center space-y-6 py-2">
                    <div class="bg-indigo-950 p-7 rounded-2xl border-2 border-indigo-500/30 shadow-inner">
                        <p class="text-xs text-indigo-300 font-black mb-1 uppercase tracking-tighter">é è¨ˆå¯ç²å¾—è–çŸ³</p>
                        <p class="text-5xl font-black text-white">ğŸ’ ${stone}</p>
                    </div>
                    <div class="text-left space-y-3 px-2">
                        <p class="text-green-400 font-black">âœ… ä¿ç•™é …ç›®ï¼šåŸºå› ç­‰ç´šã€å•†åº—å¼·åŒ–ã€è¡Œå›Šå¥—è£ã€è–çŸ³ã€‚</p>
                        <p class="text-red-400 font-black">âŒ é‡ç½®é …ç›®ï¼šç•¶å‰åœ°åŸé€²åº¦(å›1F)ã€ç¾æœ‰é‡‘å¹£ã€‚</p>
                        <p class="text-slate-400 italic text-[11px]">æç¤ºï¼šæ¯æ¬¡è½‰ç”Ÿæä¾›æ°¸ä¹… 50% æ•¸å€¼åŠ ä¹˜ (è¤‡åˆ©è¨ˆç®—)ã€‚</p>
                    </div>
                </div>`, 
                GAME_DATA.maxLevel >= 100 ? `<button onclick="reborn();closeModal()" class="w-full py-4 bg-indigo-600 rounded-2xl font-black shadow-2xl">å•Ÿå‹•è½‰ç”Ÿ</button>` : `<div class="text-sm text-red-500 font-black text-center w-full bg-red-900/20 py-4 rounded-2xl">éœ€é”åˆ°åœ°åŸ Lv.100 è§£é–</div>`
            );
        }

        function upStat(k) {
            if (GAME_DATA.gold >= GAME_DATA.costs[k]) {
                GAME_DATA.gold -= GAME_DATA.costs[k];
                GAME_DATA.stats[k]++; GAME_DATA.costs[k] = Math.floor(GAME_DATA.costs[k] * 1.35);
                updateStats(); updateUI(); switchTab(activeTab);
            } else toast("âŒ åŸºå› é‡‘å¹£ä¸è¶³", "#ef4444");
        }

        function buyShop(id) {
            const item = SHOP_ITEMS.find(i => i.id === id);
            const lv = GAME_DATA.shopLv[id] || 0;
            const cost = item.baseCost + lv;
            if (GAME_DATA.rebornStones >= cost) {
                GAME_DATA.rebornStones -= cost;
                GAME_DATA.shopLv[id]++;
                updateStats(); updateUI(); switchTab(activeTab);
                toast("âœ¨ è–çŸ³å¼·åŒ–æˆåŠŸï¼", "#a855f7");
            } else toast("âŒ è–çŸ³ä¸è¶³", "#ef4444");
        }

        function reborn() {
            const stone = Math.floor(GAME_DATA.maxLevel / 10 * (1 + GAME_DATA.shopLv.rebP * 0.1));
            GAME_DATA.rebornStones += stone;
            GAME_DATA.rebornCount++;
            GAME_DATA.level = 1; GAME_DATA.gold = 0; GAME_DATA.isTower = false; GAME_DATA.autoAdv = false;
            updateStats(); updateUI(); spawn();
        }

        function toggleTower() {
            GAME_DATA.isTower = true; GAME_DATA.towerFloor = 1; GAME_DATA.autoAdv = false;
            document.getElementById('battle-scene').style.backgroundColor = '#1e1b4b';
            updateUI(); spawn();
        }

        function equipFromInv(i) {
            const item = GAME_DATA.inv[i];
            const old = GAME_DATA.equips[item.idx];
            GAME_DATA.equips[item.idx] = item;
            GAME_DATA.inv.splice(i, 1);
            if (old && old.r === 'SET') GAME_DATA.inv.push(old);
            updateStats(); switchTab('bag');
            toast("âœ… å¥—è£ç©¿æˆ´å®Œæˆ", "#22c55e");
        }

        function deleteFromInv(i) {
            GAME_DATA.inv.splice(i, 1);
            switchTab('bag');
            toast("ğŸ—‘ï¸ å¥—è£å·²åˆ†è§£ç§»é™¤", "#94a3b8");
        }

        function toggleAuto() { if (!GAME_DATA.isTower) { GAME_DATA.autoAdv = !GAME_DATA.autoAdv; updateUI(); } }
        function goBack() { if (!GAME_DATA.isTower && GAME_DATA.level > 1) { GAME_DATA.level--; GAME_DATA.autoAdv = false; spawn(); updateUI(); } }
        
        function updateUI() {
            document.getElementById('gold-display').innerText = formatNumber(GAME_DATA.gold);
            document.getElementById('zone-display').innerText = GAME_DATA.isTower ? `æ·±æ·µ ${GAME_DATA.towerFloor}F` : `åœ°åŸ Lv.${GAME_DATA.level}`;
            document.getElementById('mode-badge').innerText = GAME_DATA.isTower ? "å‰¯æœ¬æ¨¡å¼" : (GAME_DATA.autoAdv ? "è‡ªå‹•æ¢ç´¢" : "æ‰‹å‹•æˆ°é¬¥");
            document.getElementById('reborn-status').innerText = `x${GAME_DATA.rebornCount}`;
            document.getElementById('auto-btn').innerText = `è‡ªå‹•: ${GAME_DATA.autoAdv ? 'ON' : 'OFF'}`;
            document.getElementById('auto-btn').className = `px-8 py-4 rounded-2xl text-lg font-black border-2 border-white/10 btn-main ${GAME_DATA.autoAdv ? 'bg-green-600 shadow-green-900/40' : 'bg-slate-700'}`;
        }

        function updatePlayerUI() {
            const p = (Math.max(0, player.hp) / player.maxHp) * 100;
            document.getElementById('player-hp-bar').style.width = p + "%";
            document.getElementById('player-hp-text').innerText = `${formatNumber(player.hp)} / ${formatNumber(player.maxHp)}`;
        }

        function showDmg(a, c) {
            const el = document.createElement('div'); el.className = 'hit-effect';
            el.innerText = (c ? 'ğŸ’¥' : '') + formatNumber(a);
            const scene = document.getElementById('battle-scene');
            const target = document.getElementById('monster-sprite').getBoundingClientRect();
            const sceneRect = scene.getBoundingClientRect();
            el.style.left = (target.left - sceneRect.left + target.width/2 + (Math.random()*80-40)) + 'px';
            el.style.top = (target.top - sceneRect.top + 40) + 'px';
            scene.appendChild(el); setTimeout(() => el.remove(), 800);
        }

        function toast(m, c) {
            const t = document.createElement('div');
            t.className = 'px-8 py-4 rounded-2xl text-base font-black text-white shadow-2xl border-2 border-white/10 text-center';
            t.style.backgroundColor = c; t.innerText = m;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 2500);
        }

        function showModal(h, b, a) {
            document.getElementById('modal-header').innerHTML = h;
            document.getElementById('modal-body').innerHTML = b;
            document.getElementById('modal-action').innerHTML = a || "";
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveGame() { 
            GAME_DATA.lastSave = Date.now();
            localStorage.setItem(__app_id, JSON.stringify(GAME_DATA)); 
        }

        function loadGame() {
            const saved = localStorage.getItem(__app_id);
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.keys(parsed).forEach(k => {
                    if (typeof parsed[k] === 'object' && !Array.isArray(parsed[k]) && parsed[k] !== null) {
                        Object.assign(GAME_DATA[k], parsed[k]);
                    } else {
                        GAME_DATA[k] = parsed[k];
                    }
                });
            }
        }

        window.onload = init;
    </script>
</body>
</html>