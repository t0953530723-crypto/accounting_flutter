<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç„¡é™å‹‡è€…ï¼šæ——è‰¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #020617; 
            color: white; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            touch-action: pan-y;
        }

        /* å…¨åŸŸæ¨£å¼å„ªåŒ– */
        * { user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        .custom-scroll { overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 0px; }

        /* å´é‚Šé¢æ¿ï¼šåˆå§‹æ‘ºç–Šç‹€æ…‹ */
        .side-panel {
            position: absolute;
            top: 20px;
            bottom: 120px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid #1e293b;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }

        .side-left { left: 0; border-radius: 0 20px 20px 0; width: 85px; transform: translateX(-85px); }
        .side-left.expanded { transform: translateX(0); }
        
        .side-right { right: 0; border-radius: 20px 0 0 20px; width: 120px; transform: translateX(-1px); transform: translateX(120px); }
        .side-right.expanded { transform: translateX(0); }

        .panel-handle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #4f46e5;
            padding: 12px 5px;
            font-size: 10px;
            font-weight: 900;
            cursor: pointer;
            writing-mode: vertical-lr;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            letter-spacing: 2px;
        }
        .side-left .panel-handle { right: -25px; }
        .side-right .panel-handle { left: -25px; }

        /* è£å‚™ç¶²æ ¼ 4x2 */
        .equip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; padding: 10px; }
        .equip-slot {
            aspect-ratio: 1/1.3;
            border: 1px solid #334155;
            border-radius: 12px;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            position: relative;
        }

        /* æˆ°é¬¥èˆå° */
        .battle-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            padding-bottom: 60px;
            position: relative;
        }

        .dmg-text {
            position: absolute;
            font-weight: 900;
            pointer-events: none;
            animation: fly-out 0.8s ease-out forwards;
            z-index: 100;
            text-shadow: 2px 2px 0px black;
        }
        @keyframes fly-out {
            0% { transform: translate(-50%, 0) scale(0.8); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1.3); opacity: 0; }
        }

        /* åº•éƒ¨å°èˆªï¼šåˆå§‹æ‘ºç–Š */
        .menu-container {
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 75vh;
            background: #0f172a;
            z-index: 100;
            transform: translateY(calc(75vh - 56px));
            border-top: 2px solid #4f46e5;
        }
        .menu-container.expanded { transform: translateY(0); }

        .btn-press:active { transform: scale(0.92); }
        .rarity-ur { border-color: #ef4444; color: #fca5a5; }
        .rarity-set { border-color: #22c55e; box-shadow: inset 0 0 12px #22c55e33; color: #4ade80; }
        .text-outline { text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
    </style>
</head>
<body>

    <!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
    <div class="h-16 bg-slate-950 flex items-center justify-between px-5 border-b border-slate-800 z-[110] shrink-0">
        <div class="flex flex-col">
            <span class="text-[9px] text-slate-500 font-black tracking-widest uppercase">Wealth</span>
            <span id="gold-ui" class="text-xl font-black text-yellow-400 leading-none tracking-tighter">0</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="zone-tag" class="text-[11px] font-black bg-indigo-900 px-4 py-1 rounded-full border border-indigo-500 mb-1 shadow-lg">é—œå¡ 1</div>
            <span id="stone-ui" class="text-[10px] font-bold text-emerald-400">ğŸ’ 0</span>
        </div>
        <button onclick="openReborn()" class="bg-indigo-600 px-4 py-2 rounded-xl text-[10px] font-black btn-press">
            è½‰ç”Ÿ <span id="reborn-ui">0</span>
        </button>
    </div>

    <div class="flex-1 flex relative overflow-hidden">
        <!-- å·¦å´ï¼šåŸºå› å¼·åŒ– (åˆå§‹æ‘ºç–Š) -->
        <div class="side-panel side-left" id="panel-left">
            <div class="panel-handle" onclick="toggleSide('left')">åŸºå› å¼·åŒ–</div>
            <div class="flex-1 custom-scroll py-6 px-1 space-y-4" id="gene-panel"></div>
        </div>

        <!-- ä¸­é–“ï¼šä¸»æˆ°é¬¥å€ -->
        <div class="battle-view" id="battle-area">
            <div id="enemy-sprite" class="text-9xl mb-8 drop-shadow-[0_20px_40px_rgba(0,0,0,0.8)] transition-all duration-200">ğŸ§Ÿ</div>
            <div id="enemy-name" class="text-xs font-black text-slate-400 mb-2 tracking-[0.3em] uppercase">æ®­å±</div>
            
            <!-- æ€ªç‰©è¡€æ¢ -->
            <div class="w-64 h-5 bg-slate-900 rounded-full border-2 border-slate-800 overflow-hidden relative mb-14">
                <div id="enemy-hp-bar" class="h-full bg-gradient-to-r from-red-700 to-red-500 transition-all duration-150" style="width: 100%"></div>
                <div id="enemy-hp-txt" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-outline">0 / 0</div>
            </div>

            <!-- ç©å®¶æ§åˆ¶å€ -->
            <div class="absolute bottom-8 flex flex-col items-center w-full px-8">
                <div class="w-full h-4 bg-slate-900 rounded-full border-2 border-slate-800 overflow-hidden relative mb-6">
                    <div id="player-hp-bar" class="h-full bg-gradient-to-r from-blue-700 to-cyan-500 transition-all duration-150" style="width: 100%"></div>
                    <div id="player-hp-txt" class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-outline">0 / 0</div>
                </div>
                
                <div class="flex gap-4 w-full">
                    <button id="auto-btn" onclick="toggleAuto()" class="flex-1 py-5 bg-slate-800 border-2 border-slate-700 rounded-2xl text-[11px] font-black btn-press tracking-widest">
                        æ›æ©Ÿä¸­
                    </button>
                    <button onclick="nextZone()" class="w-24 py-5 bg-indigo-600 rounded-2xl text-2xl font-black btn-press shadow-lg shadow-indigo-900/40">â”</button>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šæ­¦è£ (åˆå§‹æ‘ºç–Š) -->
        <div class="side-panel side-right" id="panel-right">
            <div class="panel-handle" onclick="toggleSide('right')">æ­¦è£é…ç½®</div>
            <div class="flex-1 custom-scroll">
                <div class="equip-grid" id="equip-panel"></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨åŠŸèƒ½é¸å–® (åˆå§‹æ‘ºç–Š) -->
    <div id="menu-root" class="menu-container flex flex-col">
        <div onclick="toggleMenu()" class="h-14 flex items-center justify-between px-6 shrink-0 bg-slate-950 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                <span class="text-xs font-black text-indigo-100 tracking-[0.2em]">çµ‚ç«¯æ©Ÿ</span>
            </div>
            <div id="menu-icon" class="text-[10px] text-indigo-400 font-black">â–² é»æ“Šå±•é–‹ä»‹é¢</div>
        </div>
        
        <div class="flex-1 custom-scroll bg-slate-900">
            <div class="flex sticky top-0 bg-slate-950 z-10 border-b border-slate-800">
                <button onclick="setTab('bag')" class="flex-1 py-4 text-[10px] font-black" id="tab-bag">å¥—è£èƒŒåŒ…</button>
                <button onclick="setTab('shop')" class="flex-1 py-4 text-[10px] font-black" id="tab-shop">è–çŸ³å•†åº—</button>
                <button onclick="setTab('tower')" class="flex-1 py-4 text-[10px] font-black" id="tab-tower">æ·±æ·µå‰¯æœ¬</button>
                <button onclick="setTab('info')" class="flex-1 py-4 text-[10px] font-black" id="tab-info">èƒ½åŠ›è©³è§£</button>
            </div>
            <div id="tab-view" class="p-5 pb-32"></div>
        </div>
    </div>

    <!-- å½ˆçª—ç³»çµ± -->
    <div id="modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-6 bg-black/95 backdrop-blur-md">
        <div class="bg-slate-900 border-2 border-indigo-500/50 rounded-[2.5rem] w-full max-w-sm overflow-hidden shadow-2xl">
            <div id="modal-title" class="p-5 bg-indigo-900/50 font-black text-center border-b border-indigo-500/30 text-indigo-100"></div>
            <div id="modal-body" class="p-8 text-[13px] text-slate-300 leading-relaxed custom-scroll max-h-[50vh]"></div>
            <div class="p-5 flex gap-3" id="modal-btns">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-800 rounded-2xl text-[11px] font-black btn-press">è¿”å›</button>
                <div id="modal-confirm" class="flex-1"></div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            monsters: [
                { n: "æ®­å±", e: "ğŸ§Ÿ" }, { n: "éª·é«", e: "ğŸ’€" }, { n: "è™è ", e: "ğŸ¦‡" },
                { n: "çŸ³é ­æ€ª", e: "ğŸ—¿" }, { n: "å·¨çŸ³åƒ", e: "ğŸ¤–" }, { n: "è›‡", e: "ğŸ" },
                { n: "å¸è¡€é¬¼", e: "ğŸ§›" }, { n: "å¹½éˆ", e: "ğŸ‘»" }
            ],
            equips: ["é ­ç›”", "è­·ç”²", "è­·è…¿", "é´å­", "æ­¦å™¨", "ç›¾ç‰Œ", "é …éŠ", "æˆ’æŒ‡"],
            shopItems: [
                { id: 'dmg', n: 'æ··æ²Œæ­¦åŠ›', d: 'æœ€çµ‚å‚·å®³ +50%', cost: 1 },
                { id: 'hp', n: 'è–å…‰ä¹‹è»€', d: 'æœ€çµ‚ç”Ÿå‘½ +50%', cost: 1 },
                { id: 'def', n: 'é‡‘å‰›æ³•é«”', d: 'æœ€çµ‚æ¸›å‚· +30%', cost: 1 },
                { id: 'spd', n: 'ç¥é€Ÿç¥ç¶“', d: 'æ”»æ“Šé€Ÿåº¦ +12%', cost: 2 },
                { id: 'critR', n: 'ç›´è¦ºæ•æ‰', d: 'æš´æ“Šç‡ +6%', cost: 2 },
                { id: 'critD', n: 'å´©è£‚ä¹‹åŠ›', d: 'æš´æ“Šå‚·å®³ +30%', cost: 2 },
                { id: 'blk', n: 'è­·èº«ç½¡æ°£', d: 'æ ¼æ“‹æ©Ÿç‡ +4%', cost: 3 },
                { id: 'drop', n: 'å¹¸é‹çœ·é¡§', d: 'æ‰å¯¶æ©Ÿç‡ +15%', cost: 2 },
                { id: 'gold', n: 'æ‹›è²¡ä¹‹éˆ', d: 'é‡‘å¹£ç²å¾— +50%', cost: 1 },
                { id: 'setR', n: 'å¥—è£å…±é³´', d: 'å¥—è£æ©Ÿç‡ +5%', cost: 5 },
                { id: 'rebP', n: 'è–çŸ³å‚³æ‰¿', d: 'è½‰ç”Ÿè–çŸ³ +20%', cost: 8 },
                { id: 'baseH', n: 'é å¤ä¹‹è¡€', d: 'åŸºç¤ç”Ÿå‘½ +2000', cost: 1 }
            ]
        };

        let DB = {
            gold: 0, stones: 0, reborn: 0,
            lv: 1, maxLv: 1,
            towerFloor: 1, isTower: false, autoPush: false,
            stats: { str: 1, sta: 1, agi: 1 },
            costs: { str: 10, sta: 10, agi: 10 },
            equips: Array(8).fill(null),
            inv: [], shop: {}, lastTS: Date.now()
        };

        let player = { hp: 100, mHp: 100, dmg: 10, def: 0, spd: 1, cR: 0.05, cD: 1.5, blk: 0, setBonus: 0 };
        let enemy = null, lastAtk = 0, isStateLocked = false;

        function f(n) {
            if (n < 1000) return Math.floor(n).toString();
            const u = ["K", "M", "B", "T", "P", "E"];
            let i = -1; let val = n;
            while (val >= 1000 && i < u.length - 1) { val /= 1000; i++; }
            return val.toFixed(1) + u[i];
        }

        function init() {
            const save = localStorage.getItem('inf_hero_v3_flagship_v2_final');
            if (save) try { DB = { ...DB, ...JSON.parse(save) }; } catch(e) {}
            handleOffline();
            updateStats();
            spawn();
            renderGenes();
            renderEquips();
            setTab('bag');
            requestAnimationFrame(tick);
            setInterval(() => {
                DB.lastTS = Date.now();
                localStorage.setItem('inf_hero_v3_flagship_v2_final', JSON.stringify(DB));
            }, 3000);
        }

        function handleOffline() {
            const diff = Math.floor((Date.now() - DB.lastTS) / 1000);
            if (diff > 60) {
                const sec = Math.min(diff, 43200); 
                const gain = Math.floor(sec * DB.maxLv * 2.5 * (1 + (DB.shop.gold||0) * 0.5));
                DB.gold += gain;
                showModal("é›¢ç·šæ”¶ç›Š", `<div class="text-center py-4"><p class="text-slate-400 mb-6 font-bold">å‹‡è€…æ–¼é›¢ç·šæœŸé–“ç¹¼çºŒæˆ°é¬¥...</p><div class="text-3xl font-black text-yellow-400 mb-2">ğŸ’° ${f(gain)}</div><p class="text-[10px] text-slate-500 uppercase">é›¢ç·šæ™‚é•·: ${Math.floor(sec/60)} åˆ†é˜</p></div>`);
            }
        }

        function updateStats() {
            const rMult = Math.pow(2.1, DB.reborn);
            const s = DB.shop;
            
            let mHp = ((1000 + (s.baseH||0) * 2000) + DB.stats.sta * 350) * rMult * (1 + (s.hp||0) * 0.5);
            let dmg = (80 + DB.stats.str * 60) * rMult * (1 + (s.dmg||0) * 0.5);
            let def = (DB.stats.sta * 30) * rMult * (1 + (s.def||0) * 0.3);
            let blk = Math.min(0.85, (DB.stats.sta * 0.005) + (s.blk||0) * 0.04);
            let spd = (1 + (DB.stats.agi * 0.04)) * (1 + (s.spd||0) * 0.12);
            let cR = 0.05 + (DB.stats.agi * 0.008) + (s.critR||0) * 0.06;
            let cD = 1.5 + (s.critD||0) * 0.3;

            let setCnt = 0;
            DB.equips.forEach(e => {
                if (e) {
                    mHp += e.h; dmg += e.a; def += e.d;
                    if (e.r === 'SET') setCnt++;
                }
            });

            // å¥—è£å…±é³´åŠ æˆ
            if (setCnt >= 2) dmg *= 1.5;
            if (setCnt >= 4) mHp *= 2.0;
            if (setCnt >= 6) def *= 2.5;
            if (setCnt >= 8) { cR += 0.35; cD += 2.5; }

            player.mHp = Math.max(1, Math.floor(mHp));
            player.dmg = Math.max(1, Math.floor(dmg));
            player.def = Math.max(0, Math.floor(def));
            player.blk = blk; player.spd = spd; player.cR = Math.min(0.95, cR); player.cD = cD;
            player.hp = player.mHp;
            player.setBonus = setCnt;
            updateUI();
        }

        function spawn() {
            isStateLocked = false;
            const floor = DB.isTower ? DB.towerFloor : DB.lv;
            const diffBase = DB.isTower ? (Math.pow(1.65, floor) * 18) : Math.pow(1.22, floor - 1);
            const m = CONFIG.monsters[Math.floor(Math.random() * CONFIG.monsters.length)];
            
            enemy = {
                n: (DB.isTower ? "ã€æ·±æ·µã€‘" : "") + m.n,
                e: m.e,
                mHp: Math.max(1, Math.floor(600 * diffBase)),
                dmg: Math.max(1, Math.floor(70 * diffBase)),
                gold: Math.floor(120 * diffBase)
            };
            enemy.hp = enemy.mHp;
            document.getElementById('enemy-sprite').innerText = enemy.e;
            document.getElementById('enemy-name').innerText = `${enemy.n} LV.${floor}`;
            renderBars();
        }

        function tick(ts) {
            if (enemy && !isStateLocked && ts - lastAtk > (1000 / player.spd)) {
                lastAtk = ts;
                const isCrit = Math.random() < player.cR;
                const pDmg = Math.max(1, Math.floor(player.dmg * (isCrit ? player.cD : 1)));
                enemy.hp = Math.max(0, enemy.hp - pDmg);
                showDmg(pDmg, isCrit, true);

                if (enemy.hp <= 0) {
                    isStateLocked = true;
                    setTimeout(onWin, 300);
                } else {
                    let eDmg = Math.max(1, enemy.dmg - player.def);
                    if (Math.random() < player.blk) eDmg = 0;
                    if (eDmg > 0) {
                        player.hp = Math.max(0, player.hp - eDmg);
                        showDmg(eDmg, false, false);
                        if (player.hp <= 0) { isStateLocked = true; setTimeout(onLoss, 300); }
                    }
                }
                renderBars();
            }
            requestAnimationFrame(tick);
        }

        function onWin() {
            DB.gold += Math.floor(enemy.gold * (1 + (DB.shop.gold||0) * 0.5));
            drop();
            player.hp = player.mHp;
            if (DB.isTower) DB.towerFloor++;
            else if (DB.autoPush) { DB.lv++; if (DB.lv > DB.maxLv) DB.maxLv = DB.lv; }
            updateUI(); spawn();
        }

        function onLoss() {
            if (DB.isTower) { 
                DB.isTower = false; 
                showModal("æ·±æ·µæˆ°æ•—", `ä½ åœ¨ç¬¬ ${DB.towerFloor} å±¤åŠ›ç«­ï¼Œå·²è¢«å‚³é€å›åœ°è¡¨ã€‚`);
                DB.towerFloor = 1; 
            } else {
                if (DB.lv > 1) DB.lv--;
                DB.autoPush = false;
            }
            player.hp = player.mHp;
            updateUI(); spawn();
        }

        function drop() {
            const luck = (DB.shop.drop || 0) * 0.15;
            const roll = Math.random();
            const chance = (DB.isTower ? 0.95 : 0.35) + luck;
            if (roll > chance) return;

            const rRoll = Math.random();
            // åªæœ‰å‰¯æœ¬æœƒæ‰è½ç¶ è‰²å¥—è£ (SET)
            const setChance = DB.isTower ? (0.35 + (DB.shop.setR||0) * 0.05) : 0;
            const urChance = setChance + (DB.isTower ? 0.40 : 0.20);
            
            let rarity = 'N';
            if (rRoll < setChance) rarity = 'SET';
            else if (rRoll < urChance) rarity = 'UR';

            const tier = Math.ceil((DB.isTower ? DB.towerFloor : DB.lv) / 10) || 1;
            const idx = Math.floor(Math.random() * 8);
            const mult = rarity === 'SET' ? 3.2 : (rarity === 'UR' ? 1.8 : 1.0);

            const item = {
                id: Date.now() + Math.random(),
                n: `${CONFIG.equips[idx]} T${tier}`,
                idx: idx, r: rarity,
                a: Math.floor(tier * 180 * mult),
                h: Math.floor(tier * 900 * mult),
                d: Math.floor(tier * 70 * mult)
            };

            if (rarity === 'SET') {
                DB.inv.push(item);
                if (currentTab === 'bag') renderBag();
            } else {
                const old = DB.equips[idx];
                const score = (it) => it.a + (it.h / 15) + it.d;
                if (!old || score(item) > score(old)) {
                    DB.equips[idx] = item;
                    updateStats(); renderEquips();
                }
            }
        }

        function toggleSide(side) { document.getElementById(`panel-${side}`).classList.toggle('expanded'); }

        function renderGenes() {
            const g = document.getElementById('gene-panel');
            const data = [{ id: 'str', n: 'åŠ›é‡', c: 'text-red-500' },{ id: 'sta', n: 'é«”è³ª', c: 'text-blue-500' },{ id: 'agi', n: 'æ•æ·', c: 'text-green-500' }];
            g.innerHTML = data.map(v => `
                <div onclick="upGene('${v.id}')" class="bg-slate-900/90 p-3 rounded-2xl border border-slate-700 flex flex-col items-center btn-press">
                    <span class="text-[9px] font-black ${v.c} mb-1">${v.n}</span>
                    <span class="text-[10px] font-bold text-white">LV.${DB.stats[v.id]}</span>
                    <span class="text-[8px] text-yellow-500 font-black mt-2">${f(DB.costs[v.id])}</span>
                </div>
            `).join('');
        }

        function upGene(id) {
            if (DB.gold >= DB.costs[id]) {
                DB.gold -= DB.costs[id];
                DB.stats[id]++;
                DB.costs[id] = Math.floor(DB.costs[id] * 1.55) + 15;
                updateStats(); renderGenes(); updateUI();
            }
        }

        function renderEquips() {
            const p = document.getElementById('equip-panel');
            p.innerHTML = CONFIG.equips.map((n, i) => {
                const e = DB.equips[i];
                return `
                    <div class="equip-slot ${e?.r === 'UR' ? 'rarity-ur' : ''} ${e?.r === 'SET' ? 'rarity-set' : ''}">
                        <span class="text-[8px] text-slate-500 font-black mb-1">${n}</span>
                        ${e ? `<span class="font-black text-[9px]">âš”ï¸${f(e.a)}</span><span class="text-[7px] text-slate-400">ğŸ›¡ï¸${f(e.d)}</span>` : '<span class="text-slate-800 text-lg font-bold">-</span>'}
                    </div>
                `;
            }).join('');
        }

        let currentTab = 'bag';
        function setTab(t) {
            currentTab = t;
            document.querySelectorAll('[id^="tab-"]').forEach(b => b.className = "flex-1 py-4 text-[10px] font-black text-slate-500");
            document.getElementById('tab-' + t).className = "flex-1 py-4 text-[10px] font-black text-indigo-400 border-b-2 border-indigo-400 bg-indigo-500/5";
            if (t === 'bag') renderBag(); else if (t === 'shop') renderShop(); else if (t === 'tower') renderTower(); else if (t === 'info') renderInfo();
        }

        function renderBag() {
            const v = document.getElementById('tab-view');
            v.innerHTML = DB.inv.length ? DB.inv.map((it, i) => `
                <div class="bg-slate-800 p-4 rounded-2xl mb-3 flex justify-between items-center border border-emerald-900/30">
                    <div>
                        <div class="text-[11px] font-black text-emerald-400">${it.n} <span class="text-[8px] bg-emerald-900 px-1 py-0.5 rounded ml-1 text-white">SET</span></div>
                        <div class="text-[9px] text-slate-400 mt-2">âš”ï¸${f(it.a)} | â¤ï¸${f(it.h)} | ğŸ›¡ï¸${f(it.d)}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="useInv(${i})" class="bg-emerald-600 px-4 py-2 rounded-xl text-[10px] font-black btn-press shadow-lg shadow-emerald-900/40">ç©¿æˆ´</button>
                        <button onclick="delInv(${i})" class="bg-red-900/30 px-4 py-2 rounded-xl text-[10px] font-black text-red-400 btn-press">åˆªé™¤</button>
                    </div>
                </div>
            `).join('') : '<div class="text-center py-20 text-slate-600 text-[11px] font-black">å‰¯æœ¬å°šæœªæ‰è½å¥—è£</div>';
        }

        function renderShop() {
            const v = document.getElementById('tab-view');
            v.innerHTML = CONFIG.shopItems.map(it => {
                const lv = DB.shop[it.id] || 0; const cost = it.cost + lv;
                return `
                    <div class="bg-slate-800/80 p-4 rounded-2xl flex justify-between items-center border border-slate-700 mb-3">
                        <div class="flex-1">
                            <div class="text-[11px] font-black text-indigo-100">${it.n} <span class="text-indigo-400 text-[9px] ml-1">LV.${lv}</span></div>
                            <div class="text-[9px] text-slate-500 mt-1">${it.d}</div>
                        </div>
                        <button onclick="buyShop('${it.id}')" class="bg-indigo-600 px-4 py-2.5 rounded-xl text-[10px] font-black ml-3 btn-press shadow-lg shadow-indigo-900/40">${cost} ğŸ’</button>
                    </div>
                `;
            }).join('');
        }

        function renderTower() {
            const v = document.getElementById('tab-view');
            v.innerHTML = `<div class="bg-slate-900 p-8 rounded-[2.5rem] border border-indigo-500/30 text-center shadow-2xl"><div class="text-7xl mb-8 animate-pulse">ğŸŒ€</div><div class="text-lg font-black text-white mb-2">æ·±æ·µå‰¯æœ¬</div><p class="text-[11px] text-slate-400 mb-10 leading-relaxed">æ­¤è™•æ‰è½å°ˆå±¬<span class="text-emerald-400 font-bold">ç¶ è‰²å¥—è£</span>ã€‚<br>é›£åº¦éš¨å±¤æ•¸<span class="text-red-500">æŒ‡æ•¸ç´šæš´å¢</span>ã€‚<br><span class="text-emerald-400 font-black mt-2 block">ç•¶å‰ï¼šç¬¬ ${DB.towerFloor} å±¤</span></p><button onclick="startTower()" class="w-full py-5 bg-indigo-600 rounded-2xl font-black text-xs btn-press">æŒ‘æˆ°æ·±æ·µ</button></div>`;
        }

        function renderInfo() {
            const v = document.getElementById('tab-view');
            v.innerHTML = `<div class="space-y-4"><div class="bg-indigo-950/40 p-5 rounded-[2rem] border border-indigo-500/20 shadow-xl"><h3 class="text-indigo-400 text-[11px] font-black mb-4 uppercase tracking-widest border-b border-indigo-500/20 pb-2">æ•¸æ“šè©³è§£</h3><div class="grid grid-cols-2 gap-y-4 text-[10px] text-slate-300 font-bold"><div>å‚·å®³ï¼š<span class="text-white">${f(player.dmg)}</span></div><div>ç”Ÿå‘½ï¼š<span class="text-white">${f(player.mHp)}</span></div><div>é˜²ç¦¦ï¼š<span class="text-white">${f(player.def)}</span></div><div>æ”»é€Ÿï¼š<span class="text-white">${player.spd.toFixed(2)}/s</span></div><div>æš´æ“Šï¼š<span class="text-white">${(player.cR*100).toFixed(1)}%</span></div><div>çˆ†å‚·ï¼š<span class="text-white">${(player.cD*100).toFixed(0)}%</span></div><div>æ ¼æ“‹ï¼š<span class="text-white">${(player.blk*100).toFixed(1)}%</span></div></div></div><div class="bg-emerald-950/40 p-5 rounded-[2rem] border border-emerald-500/20 shadow-xl"><h3 class="text-emerald-400 text-[11px] font-black mb-4 uppercase tracking-widest border-b border-emerald-500/20 pb-2">å¥—è£å…±é³´ (${player.setBonus}/8)</h3><div class="text-[10px] space-y-3 font-bold"><div class="${player.setBonus>=2?'text-emerald-200':'text-slate-600'}">ã€2ä»¶ã€‘æœ€çµ‚å‚·å®³ +50%</div><div class="${player.setBonus>=4?'text-emerald-200':'text-slate-600'}">ã€4ä»¶ã€‘æœ€çµ‚ç”Ÿå‘½ +100%</div><div class="${player.setBonus>=6?'text-emerald-200':'text-slate-600'}">ã€6ä»¶ã€‘æœ€çµ‚æ¸›å‚· +150%</div><div class="${player.setBonus>=8?'text-emerald-200':'text-slate-600'}">ã€8ä»¶ã€‘æš´æ“Š+35% / çˆ†å‚·+250%</div></div></div></div>`;
        }

        function buyShop(id) {
            const it = CONFIG.shopItems.find(x => x.id === id); const cost = it.cost + (DB.shop[id] || 0);
            if (DB.stones >= cost) { DB.stones -= cost; DB.shop[id] = (DB.shop[id] || 0) + 1; updateStats(); updateUI(); renderShop(); }
        }

        function useInv(i) {
            const it = DB.inv[i], old = DB.equips[it.idx];
            DB.equips[it.idx] = it; DB.inv.splice(i, 1); if (old) DB.inv.push(old);
            updateStats(); renderEquips(); renderBag();
        }

        function delInv(i) { DB.inv.splice(i, 1); renderBag(); }

        function startTower() {
            DB.isTower = true; DB.towerFloor = 1; DB.autoPush = false;
            if (document.getElementById('menu-root').classList.contains('expanded')) toggleMenu();
            spawn(); updateUI();
        }

        function openReborn() {
            const stones = Math.floor(DB.maxLv / 10 * (1 + (DB.shop.rebP||0) * 0.2));
            showModal("å‹‡è€…è½‰ç”Ÿå„€å¼", `<div class="text-center"><p class="text-indigo-200 font-bold mb-6">é‡ç½®æ‰€æœ‰é€²åº¦ï¼Œç²å¾—å¼·å¤§è–çŸ³ã€‚</p><div class="bg-slate-950 p-6 rounded-3xl border border-slate-800 text-left mb-6 shadow-inner"><div class="flex justify-between mb-3 text-[11px]"><span>ç•¶å‰æœ€é«˜å±¤ç´š</span><span class="text-white font-black">LV.${DB.maxLv}</span></div><div class="flex justify-between text-[11px]"><span>é è¨ˆç²å¾—è–çŸ³</span><span class="text-emerald-400 font-black">ğŸ’ ${stones}</span></div></div><p class="text-[9px] text-slate-500">è½‰ç”Ÿå¾Œé‡‘å¹£èˆ‡åŸºå› ç­‰ç´šæœƒæ­¸é›¶ã€‚</p></div>`, 
            DB.maxLv >= 100 ? `<button onclick="confirmReborn()" class="w-full py-4 bg-indigo-600 rounded-2xl text-[11px] font-black btn-press">ç¢ºèªè½‰ç”Ÿ</button>` : `<div class="text-red-500 text-[10px] font-bold text-center w-full py-2">ç­‰ç´šéœ€æ»¿ LV.100</div>`);
        }

        function confirmReborn() {
            const stones = Math.floor(DB.maxLv / 10 * (1 + (DB.shop.rebP||0) * 0.2));
            DB.stones += stones; DB.reborn++; DB.lv = 1; DB.gold = 0; DB.autoPush = false; DB.isTower = false;
            DB.stats = { str: 1, sta: 1, agi: 1 }; DB.costs = { str: 10, sta: 10, agi: 10 };
            updateStats(); updateUI(); spawn(); renderGenes(); closeModal();
        }

        function toggleMenu() {
            const m = document.getElementById('menu-root'); const i = document.getElementById('menu-icon');
            const isEx = m.classList.toggle('expanded'); i.innerText = isEx ? "â–¼ é»æ“Šæ‘ºç–Šä»‹é¢" : "â–² é»æ“Šå±•é–‹ä»‹é¢";
        }

        function toggleAuto() { if (!DB.isTower) { DB.autoPush = !DB.autoPush; updateUI(); if (DB.autoPush) spawn(); } }
        function nextZone() { if (!DB.isTower) { DB.autoPush = true; updateUI(); spawn(); } }

        function updateUI() {
            document.getElementById('gold-ui').innerText = f(DB.gold);
            document.getElementById('stone-ui').innerText = `ğŸ’ ${f(DB.stones)}`;
            document.getElementById('reborn-ui').innerText = DB.reborn;
            document.getElementById('zone-tag').innerText = DB.isTower ? `æ·±æ·µ ${DB.towerFloor}F` : `é—œå¡ ${DB.lv}`;
            document.getElementById('auto-btn').innerText = DB.autoPush ? "æ¨é—œä¸­" : "æ›æ©Ÿä¸­";
            document.getElementById('auto-btn').style.background = DB.autoPush ? "#312e81" : "#1e293b";
        }

        function renderBars() {
            if (!enemy) return;
            const ep = Math.min(100, Math.max(0, (enemy.hp/enemy.mHp*100)));
            const pp = Math.min(100, Math.max(0, (player.hp/player.mHp*100)));
            document.getElementById('enemy-hp-bar').style.width = ep + '%';
            document.getElementById('player-hp-bar').style.width = pp + '%';
            document.getElementById('enemy-hp-txt').innerText = `${f(enemy.hp)} / ${f(enemy.mHp)}`;
            document.getElementById('player-hp-txt').innerText = `${f(player.hp)} / ${f(player.mHp)}`;
        }

        function showDmg(d, c, isP) {
            const el = document.createElement('div'); el.className = 'dmg-text'; el.style.left = '50%';
            el.style.top = isP ? '40%' : '65%'; el.style.color = isP ? (c ? '#fbbf24' : '#ffffff') : '#f87171';
            el.style.fontSize = c ? '30px' : '20px'; el.innerText = f(d);
            document.getElementById('battle-area').appendChild(el);
            if (isP && d > 0) { document.getElementById('enemy-sprite').style.transform = "scale(0.8) translateY(10px)"; setTimeout(() => document.getElementById('enemy-sprite').style.transform = "scale(1)", 100); }
            setTimeout(() => el.remove(), 800);
        }

        function showModal(t, b, c) {
            document.getElementById('modal-title').innerText = t; document.getElementById('modal-body').innerHTML = b;
            document.getElementById('modal-confirm').innerHTML = c || ""; document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        window.onload = init;
    </script>
</body>
</html>
