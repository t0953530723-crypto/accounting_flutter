<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç„¡é™å‹‡è€…ï¼šåœ°åŸä¿®ç…‰ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #020617; 
            color: white; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
            overflow: hidden; 
            touch-action: manipulation;
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        .custom-scroll {
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* è£å‚™æ¬„æ ¼å­ */
        .equip-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
            padding: 10px;
        }
        
        .equip-card {
            aspect-ratio: 1/1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.4);
            transition: all 0.2s;
        }

        /* åˆå§‹æ‘ºç–Šé‚è¼¯ */
        .foldable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(15, 23, 42, 0.98);
        }
        .foldable-content.expanded {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* æ•¸å€¼æ”¾å¤§é¡¯ç¤º */
        .stat-val { 
            font-size: 0.95rem; 
            font-weight: 900; 
            line-height: 1.2; 
            text-shadow: 1px 1px 2px black;
        }
        .rarity-ur { box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); border-color: #ef4444 !important; }
        .rarity-set { box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); border-color: #22c55e !important; }

        /* æˆ°é¬¥é£„å­— */
        .hit-effect {
            position: absolute; pointer-events: none; color: #f87171; font-weight: 900; font-size: 2rem;
            animation: fly-up 0.8s ease-out forwards; z-index: 50; text-shadow: 2px 2px 0px #000;
        }
        @keyframes fly-up { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }

        .tab-btn { flex: 1; padding: 14px 0; font-size: 0.9rem; font-weight: 700; color: #64748b; border-bottom: 4px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: #6366f1; background: rgba(51, 65, 85, 0.3); }

        .btn-click { @apply active:scale-90 transition-transform cursor-pointer; }
    </style>
</head>
<body class="custom-scroll">

    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <div class="p-3 bg-slate-950 border-b border-slate-800 flex justify-between items-center shrink-0 z-50">
        <div class="flex flex-col items-start">
            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">æŒæœ‰é‡‘å¹£</span>
            <span id="gold-display" class="text-yellow-400 font-black text-2xl tracking-tight">0</span>
        </div>
        <div class="flex flex-col items-center">
            <div id="mode-badge" class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-slate-400 mb-1">åœ°åŸæ¢éšª</div>
            <span id="zone-display" class="text-base font-black text-white">Lv.1</span>
        </div>
        <button onclick="showRebornDetails()" class="bg-indigo-600 px-5 py-2 rounded-xl text-xs font-black btn-click shadow-lg shadow-indigo-900/40">
            è½‰ç”Ÿ <span id="reborn-status" class="opacity-70">x0</span>
        </button>
    </div>

    <!-- æˆ°é¬¥ä¸­å¿ƒå€åŸŸ -->
    <div id="battle-scene" class="relative flex-1 bg-slate-900 flex flex-col items-center justify-center overflow-hidden min-h-[320px]">
        <div id="monster-container" class="flex flex-col items-center w-full">
            <div id="monster-sprite" class="text-[120px] mb-4 select-none drop-shadow-2xl transition-transform active:scale-90 duration-75">ğŸ§Ÿ</div>
            <div id="monster-name" class="text-2xl font-black mb-4 text-slate-100 drop-shadow-md">è¼‰å…¥ä¸­...</div>
            
            <!-- æ€ªç‰©è¡€æ¢ -->
            <div class="w-3/4 h-6 bg-black/50 rounded-full border-2 border-slate-700 overflow-hidden relative shadow-inner">
                <div id="monster-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-rose-500 transition-all duration-150" style="width: 100%;"></div>
            </div>
            
            <div class="flex gap-4 mt-10">
                <button onclick="toggleAuto()" id="auto-btn" class="bg-slate-700 px-8 py-4 rounded-2xl text-base font-black border border-white/20 btn-click shadow-xl">è‡ªå‹•: OFF</button>
                <button onclick="goBack()" class="bg-slate-800/80 px-8 py-4 rounded-2xl text-base font-black border border-slate-700 btn-click shadow-xl">æ’¤é€€</button>
            </div>
        </div>

        <!-- ç©å®¶è¡€æ¢ (åº•éƒ¨æ‡¸æµ®) -->
        <div class="absolute bottom-8 left-10 right-10">
            <div class="flex justify-between text-[11px] font-bold text-blue-400 mb-1 tracking-widest">
                <span>å‹‡è€…ç”Ÿå‘½å€¼</span>
                <span id="player-hp-text">0 / 0</span>
            </div>
            <div class="w-full h-4 bg-black rounded-full overflow-hidden border-2 border-slate-800 shadow-lg">
                <div id="player-hp-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- è£å‚™é¢æ¿ (åˆå§‹æ‘ºç–Š) -->
    <div class="bg-slate-950 border-t border-slate-800 shrink-0">
        <div onclick="toggleFold('equip-content', 'fold-icon-equip')" class="py-4 px-6 flex justify-between items-center cursor-pointer hover:bg-slate-900 active:bg-slate-800 transition-colors">
            <span class="text-xs font-black text-slate-400 tracking-widest">å‹‡è€…è£å‚™æ¬„ (é»æ“Šå±•é–‹)</span>
            <div id="fold-icon-equip" class="text-slate-500 text-sm">â–²</div>
        </div>
        <div id="equip-content" class="foldable-content">
            <div id="equipment-slots" class="equip-grid"></div>
            <div id="set-bonus-display" class="px-6 pb-6 text-xs font-bold text-green-400 text-center bg-slate-950 italic"></div>
        </div>
    </div>

    <!-- åŠŸèƒ½é¸å–® (åˆå§‹æ‘ºç–Š) -->
    <div class="bg-slate-950 border-t border-slate-800 flex flex-col shrink-0">
        <div onclick="toggleFold('menu-content', 'fold-icon-menu')" class="py-4 px-6 flex justify-between items-center cursor-pointer hover:bg-slate-900 active:bg-slate-800 transition-colors">
            <span class="text-xs font-black text-indigo-400 tracking-widest">ç³»çµ±ä¸»åŠŸèƒ½ (é»æ“Šå±•é–‹)</span>
            <div id="fold-icon-menu" class="text-indigo-400 text-sm">â–²</div>
        </div>
        
        <div id="menu-content" class="foldable-content">
            <div class="flex bg-slate-950 border-b border-slate-800 sticky top-0 z-10">
                <button onclick="switchTab('upgrade')" id="btn-upgrade" class="tab-btn active">åŸºå› å¼·åŒ–</button>
                <button onclick="switchTab('bag')" id="btn-bag" class="tab-btn">å‹‡è€…è¡Œå›Š</button>
                <button onclick="switchTab('tower')" id="btn-tower" class="tab-btn text-purple-400">æ·±æ·µå‰¯æœ¬</button>
                <button onclick="switchTab('shop')" id="btn-shop" class="tab-btn">è–çŸ³å•†åº—</button>
            </div>
            <div id="tab-content" class="min-h-[300px] max-h-[45vh] overflow-y-auto p-5 custom-scroll bg-slate-900/30"></div>
        </div>
    </div>

    <!-- ç³»çµ±å½ˆçª— -->
    <div id="modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-black/90 backdrop-blur-md">
        <div class="bg-slate-900 border-2 border-slate-700 rounded-3xl w-full max-w-sm overflow-hidden flex flex-col shadow-2xl">
            <div id="modal-header" class="p-5 bg-slate-800 font-black text-base border-b border-slate-700 text-center tracking-widest"></div>
            <div id="modal-body" class="p-6 text-sm text-slate-300 leading-relaxed custom-scroll max-h-[50vh]"></div>
            <div id="modal-footer" class="p-5 flex gap-4 border-t border-slate-800 bg-slate-950/50">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-700 rounded-2xl text-sm font-black btn-click text-slate-300">é—œé–‰</button>
                <div id="modal-action" class="flex-1"></div>
            </div>
        </div>
    </div>

    <!-- æç¤ºé€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="fixed top-28 left-1/2 -translate-x-1/2 z-[110] flex flex-col gap-3 pointer-events-none w-3/4"></div>

    <script>
        const __app_id = "infinite_hero_pro_v5";
        
        // åš´æ ¼é–å®šæ€ªç‰©ç¨®é¡
        const MONSTER_POOL = [
            { n: "è…çˆ›æ®­å±", e: "ğŸ§Ÿ" }, { n: "æ¯éª¨æˆ°å£«", e: "ğŸ’€" }, { n: "å¸è¡€è™è ", e: "ğŸ¦‡" },
            { n: "é ‘å›ºçŸ³é ­æ€ª", e: "ğŸ—¿" }, { n: "å¤ä»£å·¨çŸ³åƒ", e: "ğŸ¤–" }, { n: "æ£®æ—åŠ‡æ¯’è›‡", e: "ğŸ" }
        ];

        // éŠæˆ²ç‹€æ…‹è³‡æ–™
        const GAME_DATA = {
            gold: 0, rebornStones: 0, rebornCount: 0,
            level: 1, maxLevel: 1,
            autoAdv: false, isTower: false, towerFloor: 1,
            stats: { str: 1, sta: 1, agi: 1 },
            costs: { str: 10, sta: 10, agi: 10 },
            equips: Array(8).fill(null),
            inv: [],
            shopLv: { dmg:0, hp:0, def:0, spd:0, critR:0, drop:0, gold:0, critD:0, block:0, setR:0, rebP:0, hP:0 },
            lastSave: Date.now()
        };

        // è½‰ç”Ÿå•†åº— (12ä»¶å•†å“)
        const SHOP_ITEMS = [
            { id: 'dmg', n: 'ç ´å£ä¹‹åŠ›', d: 'å…¨å‚·å®³æå‡ +50%', baseCost: 1 },
            { id: 'hp', n: 'ç”Ÿå‘½æ³‰æº', d: 'å…¨ç”Ÿå‘½æå‡ +50%', baseCost: 1 },
            { id: 'def', n: 'é‹¼éµæ„å¿—', d: 'æ¸›å‚·é˜²ç¦¦åŠ› +30%', baseCost: 1 },
            { id: 'spd', n: 'æ¥µé™è¶…é »', d: 'æ”»æ“Šé€Ÿåº¦æå‡ +10%', baseCost: 2 },
            { id: 'critR', n: 'ç²¾ç¢ºæ‰“æ“Š', d: 'æš´æ“Šç‡ +5%', baseCost: 2 },
            { id: 'critD', n: 'è‡´å‘½ä¸€æ“Š', d: 'æš´æ“Šå‚·å®³ +25%', baseCost: 2 },
            { id: 'block', n: 'è–å…‰æ ¼æ“‹', d: 'æ ¼æ“‹ç‡ +3% (ä¸Šé™70%)', baseCost: 3 },
            { id: 'drop', n: 'å°‹å¯¶ä¹‹ç³', d: 'è£å‚™æ‰è½ç‡ +10%', baseCost: 3 },
            { id: 'gold', n: 'é»çŸ³æˆé‡‘', d: 'é‡‘å¹£ç²å¾—é‡ +50%', baseCost: 2 },
            { id: 'setR', n: 'å¥—è£å…±é³´', d: 'å¥—è£å‡ºç¾æ©Ÿç‡ +5%', baseCost: 5 },
            { id: 'rebP', n: 'è¼ªè¿´å›é¥‹', d: 'è½‰ç”ŸçŸ³ç²å–é‡ +15%', baseCost: 8 },
            { id: 'hP', n: 'åŸå§‹é«”è³ª', d: 'åŸºç¤ç”Ÿå‘½å€¼ +500', baseCost: 1 }
        ];

        const TYPES = ["é ­ç›”", "è­·ç”²", "è­·è…¿", "é´å­", "æ­¦å™¨", "ç›¾ç‰Œ", "é …éŠ", "æˆ’æŒ‡"];
        const RARITIES = [
            { id: 'N', name: 'æ™®é€š', color: '#94a3b8', chance: 0.6, mult: 1 },
            { id: 'R', name: 'ç¨€æœ‰', color: '#3b82f6', chance: 0.25, mult: 2.2 },
            { id: 'SR', name: 'å²è©©', color: '#a855f7', chance: 0.1, mult: 4.8 },
            { id: 'SSR', name: 'å‚³å¥‡', color: '#f59e0b', chance: 0.04, mult: 10 },
            { id: 'UR', name: 'ç¥è©±', color: '#ef4444', chance: 0.01, mult: 25 },
            { id: 'SET', name: 'å¥—è£', color: '#22c55e', chance: 0, mult: 28.0 }
        ];

        let player = { hp: 100, maxHp: 100, dmg: 5, def: 0, block: 0, spd: 1, critR: 0.05, critD: 1.5 };
        let enemy = null;
        let lastAtk = 0;
        let activeTab = 'upgrade';

        // æ ¼å¼åŒ–æ•¸å­— (é˜²æ­¢é€šè†¨é¡¯ç¤º)
        function formatNumber(n) {
            if (n < 1000) return Math.floor(n).toString();
            const units = ["K", "M", "B", "T", "P", "E"];
            let u = -1;
            do { n /= 1000; u++; } while (n >= 1000 && u < units.length - 1);
            return n.toFixed(1) + units[u];
        }

        function init() {
            loadGame();
            handleOffline();
            updateStats();
            spawn();
            switchTab('upgrade');
            requestAnimationFrame(gameLoop);
            setInterval(saveGame, 10000);
        }

        // é›¢ç·šæ”¶ç›Šè¨ˆç®—
        function handleOffline() {
            const now = Date.now();
            const diff = Math.floor((now - GAME_DATA.lastSave) / 1000);
            if (diff > 60) {
                const limit = Math.min(diff, 12 * 3600); // æœ€é«˜ 12 å°æ™‚
                const rate = GAME_DATA.maxLevel * 5 * (1 + GAME_DATA.shopLv.gold * 0.5);
                const earned = Math.floor(rate * limit);
                GAME_DATA.gold += earned;
                showModal("é›¢ç·šæƒè•©çµç®—", `
                    å‹‡è€…åœ¨æ‚¨ä¸åœ¨çš„æ™‚é–“è£¡æŒçºŒæ–¼åœ°åŸæƒè•©...<br><br>
                    é›¢ç·šæ™‚é•·ï¼š<b>${Math.floor(limit/3600)}æ™‚${Math.floor((limit%3600)/60)}åˆ†</b><br>
                    ç´¯è¨ˆé‡‘å¹£æ”¶ç›Šï¼š<br>
                    <span class="text-3xl font-black text-yellow-400">ğŸ’° ${formatNumber(earned)}</span>
                `);
            }
        }

        function gameLoop(now) {
            if (enemy && enemy.hp > 0 && player.hp > 0 && (now - lastAtk >= (1000/player.spd))) {
                let isCrit = Math.random() < player.critR;
                let d = Math.max(1, Math.floor(player.dmg * (isCrit ? player.critD : 1)));
                enemy.hp -= d;
                showDmg(d, isCrit);
                
                if (enemy.hp <= 0) {
                    die();
                } else {
                    let ed = Math.max(0, enemy.dmg - player.def);
                    if (Math.random() < player.block) { 
                        ed = 0; 
                        toast("ğŸ›¡ï¸ æ ¼æ“‹ï¼å‚·å®³ç„¡æ•ˆ", "#3b82f6"); 
                    }
                    player.hp = Math.max(0, player.hp - ed);
                    updatePlayerUI();
                    if (player.hp <= 0) pDie();
                }
                lastAtk = now;
                updateEnemyUI();
            }
            requestAnimationFrame(gameLoop);
        }

        function spawn() {
            const floor = GAME_DATA.isTower ? GAME_DATA.towerFloor : GAME_DATA.level;
            // å‰¯æœ¬é›£åº¦åŠ å¼·
            const diffMult = GAME_DATA.isTower ? (Math.pow(1.6, floor) * 18) : Math.pow(1.23, floor-1);
            const m = MONSTER_POOL[Math.floor(Math.random() * MONSTER_POOL.length)];
            
            enemy = {
                name: GAME_DATA.isTower ? `[æ·±æ·µ] ${m.n} ${floor}F` : `${m.n} Lv.${floor}`,
                maxHp: Math.floor(100 * diffMult),
                dmg: Math.floor(18 * diffMult),
                gold: Math.floor(25 * diffMult),
                emoji: m.e
            };
            enemy.hp = enemy.maxHp;
            document.getElementById('monster-sprite').innerText = enemy.emoji;
            document.getElementById('monster-name').innerText = enemy.name;
            updateEnemyUI();
        }

        function die() {
            GAME_DATA.gold += Math.floor(enemy.gold * (1 + GAME_DATA.shopLv.gold * 0.5));
            // æ™®é€šåœ°åŸ 10 å±¤æ‰è½ä¸€æ¬¡è£å‚™ï¼Œå‰¯æœ¬æ¯å±¤æ‰è½
            if (GAME_DATA.isTower || (GAME_DATA.level % 10 === 0)) dropItem();
            
            if (GAME_DATA.isTower) { 
                GAME_DATA.towerFloor++; 
            } else if (GAME_DATA.autoAdv) { 
                GAME_DATA.level++; 
                if (GAME_DATA.level > GAME_DATA.maxLevel) GAME_DATA.maxLevel = GAME_DATA.level; 
            }
            
            player.hp = player.maxHp;
            updateUI(); updatePlayerUI(); setTimeout(spawn, 300);
        }

        function pDie() {
            toast("ğŸ’€ æˆ°æ•—æ’¤é€€ï¼šæŒ‘æˆ°å¤±æ•—", "#ef4444");
            GAME_DATA.autoAdv = false;
            if (GAME_DATA.isTower) { 
                GAME_DATA.isTower = false; 
                GAME_DATA.towerFloor = 1; 
                document.getElementById('battle-scene').style.backgroundColor = ''; 
            } else if (GAME_DATA.level > 1) {
                GAME_DATA.level--;
            }
            player.hp = player.maxHp;
            updateUI(); updatePlayerUI(); setTimeout(spawn, 1000);
        }

        function updateStats() {
            const rb = Math.pow(1.5, GAME_DATA.rebornCount);
            const s = GAME_DATA.shopLv;
            
            // åŸºç¤åŸºå› æ•¸å€¼
            let mHp = ((200 + s.hP * 500) + GAME_DATA.stats.str * 60) * rb * (1 + s.hp * 0.5);
            let dmg = (10 + GAME_DATA.stats.str * 10) * rb * (1 + s.dmg * 0.5);
            let def = (GAME_DATA.stats.sta * 6) * rb * (1 + s.def * 0.3);
            let blk = Math.min(0.7, (GAME_DATA.stats.sta * 0.015) + s.block * 0.03);
            let spd = (1 + (GAME_DATA.stats.agi * 0.08)) * (1 + s.spd * 0.1);
            let cR = 0.05 + (GAME_DATA.stats.agi * 0.01) + (s.critR * 0.05);
            let cD = 1.5 + s.critD * 0.25;

            // è£å‚™æ•¸å€¼åŠ æˆ
            let sets = 0;
            GAME_DATA.equips.forEach(e => { 
                if (e) { 
                    mHp += e.h; dmg += e.a; def += e.d; 
                    if (e.r === 'SET') sets++; 
                } 
            });

            // å¥—è£å±¬æ€§åŠ æˆå¯¦ä½œ
            let bTxt = [];
            if (sets >= 2) { dmg *= 1.5; bTxt.push("2ä»¶:å‚·å®³+50%"); }
            if (sets >= 4) { mHp *= 1.8; bTxt.push("4ä»¶:ç”Ÿå‘½+80%"); }
            if (sets >= 6) { def *= 2.5; bTxt.push("6ä»¶:é˜²ç¦¦+150%"); }
            if (sets >= 8) { cD += 2.0; bTxt.push("8ä»¶:æš´å‚·+200%"); }

            player.maxHp = Math.floor(mHp);
            player.dmg = Math.floor(dmg);
            player.def = Math.floor(def);
            player.block = blk;
            player.spd = spd;
            player.critR = cR;
            player.critD = cD;
            
            if (player.hp > player.maxHp || player.hp <= 0) player.hp = player.maxHp;
            document.getElementById('set-bonus-display').innerText = bTxt.join(" â—ˆ ") || "ç•¶å‰æœªæ¿€æ´»å¥—è£å…±é³´";
            renderEquips();
        }

        function renderEquips() {
            const container = document.getElementById('equipment-slots');
            container.innerHTML = '';
            TYPES.forEach((t, i) => {
                const eq = GAME_DATA.equips[i];
                const r = eq ? RARITIES.find(x => x.id === eq.r) : null;
                const div = document.createElement('div');
                div.className = `equip-card ${eq?.r === 'UR' ? 'rarity-ur' : ''} ${eq?.r === 'SET' ? 'rarity-set' : ''}`;
                if (eq) {
                    div.style.borderColor = r.color;
                    div.innerHTML = `
                        <span class="text-[9px] font-black uppercase" style="color:${r.color}">${r.name}</span>
                        <div class="flex flex-col items-center mt-1">
                            <span class="stat-val text-red-400">âš”ï¸${formatNumber(eq.a)}</span>
                            <span class="stat-val text-blue-400">â¤ï¸${formatNumber(eq.h)}</span>
                        </div>`;
                } else {
                    div.innerHTML = `<span class="text-[10px] font-black text-slate-600">${t}</span>`;
                }
                container.appendChild(div);
            });
        }

        function dropItem() {
            let r = null;
            // å¥—è£æ‰è½æ©Ÿç‡ (å•†åº—åŠ æˆ + å‰¯æœ¬åŠ æˆ)
            const sR = (GAME_DATA.isTower ? 0.35 : 0.05) + (GAME_DATA.shopLv.setR * 0.05);
            
            if (Math.random() < sR) { 
                r = RARITIES.find(x => x.id === 'SET'); 
            } else {
                let roll = Math.random();
                let cur = 0;
                let mult = 1 + (GAME_DATA.shopLv.drop * 0.1);
                for (const x of RARITIES) {
                    let c = x.chance * (x.id !== 'N' ? mult : 1);
                    cur += c; 
                    if (roll < cur) { r = x; break; }
                }
            }
            if (!r) r = RARITIES[0];

            const idx = Math.floor(Math.random() * 8);
            const tier = Math.ceil((GAME_DATA.isTower ? GAME_DATA.towerFloor : GAME_DATA.level) / 10);
            const item = { 
                id: Math.random(), 
                n: `${TYPES[idx]} T${tier}`, 
                idx, r: r.id, tier, 
                h: tier * 150 * r.mult, 
                a: tier * 30 * r.mult, 
                d: tier * 15 * r.mult 
            };
            
            if (r.id === 'SET') {
                if (GAME_DATA.inv.length < 40) { 
                    GAME_DATA.inv.push(item); 
                    toast("ğŸŸ¢ ç¨€æœ‰å¥—è£æ‰è½ï¼å·²æ”¶ç´è‡³è¡Œå›Š", "#22c55e"); 
                    if (activeTab === 'bag') switchTab('bag'); 
                } else {
                    toast("âŒ è¡Œå›Šç©ºé–“ä¸è¶³ï¼Œå¥—è£è¢«æ¯€æ»…äº†", "#ef4444");
                }
            } else {
                const old = GAME_DATA.equips[idx];
                const score = (i) => i ? (i.a * 10 + i.d * 8 + i.h / 5) : 0;
                if (score(item) > score(old)) { 
                    GAME_DATA.equips[idx] = item; 
                    updateStats(); 
                    toast(`ğŸ›¡ï¸ ç©¿æˆ´æ›´é«˜æˆ°åŠ›: ${r.name}`, "#3b82f6"); 
                }
            }
        }

        function toggleFold(target, icon) {
            const el = document.getElementById(target);
            const ic = document.getElementById(icon);
            const isExpanded = el.classList.toggle('expanded');
            ic.innerText = isExpanded ? 'â–¼' : 'â–²';
        }

        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${t}`).classList.add('active');
            const box = document.getElementById('tab-content');
            box.innerHTML = '';
            
            if (t === 'upgrade') {
                box.innerHTML = `<div class="space-y-4">
                    ${renderUp('æ”»æ“ŠåŸºå› ', 'str', 'å¤§å¹…æå‡ æ”»æ“Š/ç”Ÿå‘½', '#ef4444')}
                    ${renderUp('ç”Ÿå­˜åŸºå› ', 'sta', 'æå‡ é˜²ç¦¦/æ ¼æ“‹æ©Ÿç‡', '#3b82f6')}
                    ${renderUp('è¶…é »åŸºå› ', 'agi', 'æå‡ æ”»é€Ÿ/æš´æ“Šç‡', '#22c55e')}
                    <button onclick="showDtl('attr')" class="w-full py-4 text-xs text-slate-500 font-black border-2 border-slate-800 rounded-2xl">åŸºå› èˆ‡å±¬æ€§è©³ç´°èªªæ˜</button>
                </div>`;
            } else if (t === 'bag') {
                box.innerHTML = `<div class="grid grid-cols-1 gap-4">
                    ${GAME_DATA.inv.map((it, i) => `
                        <div class="bg-slate-800 border-2 border-green-600/50 rounded-2xl p-4 flex justify-between items-center shadow-lg">
                            <div class="text-left">
                                <p class="text-base font-black text-white">${it.n}</p>
                                <p class="text-xs text-green-400 font-bold">âš”ï¸${formatNumber(it.a)} â¤ï¸${formatNumber(it.h)} ğŸ›¡ï¸${formatNumber(it.d)}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="equipInv(${i})" class="bg-green-700 px-4 py-2 rounded-xl text-xs font-black btn-click">ç©¿æˆ´</button>
                                <button onclick="delInv(${i})" class="bg-red-900/40 px-4 py-2 rounded-xl text-xs font-black btn-click text-red-200">åˆ†è§£</button>
                            </div>
                        </div>`).join('')}
                    ${GAME_DATA.inv.length === 0 ? '<div class="py-16 text-slate-600 font-bold">è¡Œå›Šç©ºç©ºå¦‚ä¹Ÿ</div>' : ''}
                </div>`;
            } else if (t === 'shop') {
                box.innerHTML = `<div class="bg-indigo-950/60 p-6 rounded-2xl border-2 border-indigo-500/30 mb-5 flex justify-between items-center shadow-2xl">
                    <span class="text-3xl font-black text-white">ğŸ’ ${GAME_DATA.rebornStones}</span>
                    <span class="text-xs text-indigo-400 font-black tracking-widest">è–çŸ³æ®˜é¤˜</span>
                </div>
                <div class="space-y-4">${SHOP_ITEMS.map(i => renderShop(i)).join('')}</div>`;
            } else if (t === 'tower') {
                showDtl('tower');
            }
        }

        function renderUp(n, k, d, c) {
            return `<div class="bg-slate-800 p-5 rounded-2xl flex justify-between items-center border-2 border-slate-700 shadow-md">
                <div class="text-left"><p class="text-base font-black" style="color:${c}">${n} Lv.${GAME_DATA.stats[k]}</p><p class="text-xs text-slate-500">${d}</p></div>
                <button onclick="upStat('${k}')" class="bg-slate-900 px-5 py-3 rounded-xl text-sm font-black text-yellow-400 btn-click ring-1 ring-yellow-500/20">ğŸ’° ${formatNumber(GAME_DATA.costs[k])}</button>
            </div>`;
        }

        function renderShop(it) {
            const lv = GAME_DATA.shopLv[it.id] || 0;
            const cost = it.baseCost + lv;
            return `<div class="bg-slate-800 p-5 rounded-2xl flex justify-between items-center border-2 border-slate-700">
                <div class="text-left pr-3"><p class="text-base font-black text-white">${it.n} [${lv}]</p><p class="text-xs text-slate-500">${it.d}</p></div>
                <button onclick="buyShop('${it.id}')" class="bg-indigo-900 px-5 py-3 rounded-xl text-sm font-black btn-click shadow-lg">${cost} ğŸ’</button>
            </div>`;
        }

        function showDtl(type) {
            if (type === 'attr') {
                showModal("åŸºå› å±¬æ€§èˆ‡è½‰ç”Ÿèªªæ˜", `
                    <p class="mb-3"><b class="text-red-400">åŠ›é‡ (STR)</b>: æå‡ 60 åŸºç¤æ”»æ“Šèˆ‡ 500 æœ€å¤§ç”Ÿå‘½ã€‚</p>
                    <p class="mb-3"><b class="text-blue-400">ç”Ÿå­˜ (STA)</b>: æå‡ 6 åŸºç¤é˜²ç¦¦ï¼Œä¸¦å¢åŠ  1.5% æ ¼æ“‹ç‡ã€‚</p>
                    <p class="mb-3"><b class="text-green-400">è¶…é » (AGI)</b>: æå‡ 8% æ”»é€Ÿèˆ‡ 1% æš´æ“Šæ©Ÿç‡ã€‚</p>
                    <hr class="border-slate-700 my-4">
                    <p class="text-indigo-300"><b>è½‰ç”ŸåŠ æˆï¼š</b>æ¯æ¬¡è½‰ç”Ÿä½¿è§’è‰²ç¸½é«”å¯¦åŠ›æå‡ 50% (ä¹˜æ³•è¨ˆç®—)ï¼Œé€™æ˜¯å…‹æœé«˜é›£åº¦å‰¯æœ¬çš„å”¯ä¸€é€”å¾‘ã€‚</p>
                `);
            } else if (type === 'tower') {
                showModal("æ·±æ·µç¦åœ°å‰¯æœ¬", `
                    <div class="text-center space-y-4">
                        <p class="text-purple-400 font-black text-lg">âš ï¸ æ¥µé«˜é›£åº¦è­¦å‘Š</p>
                        <p class="text-slate-400">æ·±æ·µä¸­çš„æ€ªç‰©å±¬æ€§ç‚ºå¤–ç•Œçš„ 15-20 å€ï¼Œä¸”éš¨è‘—å±¤æ•¸é£›é€Ÿå¢å¼·ã€‚è‹¥åœ¨å‰¯æœ¬ä¸­æˆ°äº¡ï¼Œæ¢éšªå°‡ç›´æ¥çµ‚æ­¢ã€‚</p>
                        <p class="text-green-400 font-bold">å°ˆå±¬æ‰è½ï¼šå‚³èªªå¥—è£</p>
                        <p class="text-xs text-slate-500">å¥—è£æä¾›ç¨æœ‰çš„ 2/4/6/8 ä»¶å…±é³´å±¬æ€§ï¼Œæ˜¯éŠæˆ²ä¸­å¾ŒæœŸæœ€å¼·å¤§çš„åŠ›é‡ä¾†æºã€‚</p>
                    </div>
                `, `<button onclick="startTower();closeModal()" class="w-full py-5 bg-purple-600 rounded-2xl text-base font-black shadow-xl btn-click">è¸å…¥æ·±æ·µ</button>`);
            }
        }

        function showRebornDetails() {
            const stone = Math.floor(GAME_DATA.maxLevel / 10 * (1 + GAME_DATA.shopLv.rebP * 0.15));
            showModal("è¼ªè¿´ï¼šå¤è€è½‰ç”Ÿ", `
                <div class="text-center space-y-6">
                    <div class="bg-indigo-950 p-6 rounded-3xl border-2 border-indigo-500/40">
                        <p class="text-xs text-indigo-300 font-black uppercase mb-2">æœ¬æ¬¡è¼ªè¿´å¯é ˜å–è–çŸ³</p>
                        <p class="text-5xl font-black text-white tracking-tighter">ğŸ’ ${stone}</p>
                    </div>
                    <div class="text-left text-xs text-slate-400 space-y-2 bg-black/30 p-4 rounded-xl">
                        <p>âœ… ä¿ç•™ï¼šåŸºå› ç­‰ç´šã€è¡Œå›Šå¥—è£ã€è–çŸ³å•†åº—å¼·åŒ–</p>
                        <p>âŒ é‡ç½®ï¼šç›®å‰åœ°åŸå±¤æ•¸ã€ç•¶å‰é‡‘å¹£ã€å‰¯æœ¬é€²åº¦</p>
                        <p class="text-indigo-400 font-bold">âœ¨ ç‰¹æ•ˆï¼šå…¨å±¬æ€§æ°¸ä¹… Ã—1.5 å€å¢é•·</p>
                    </div>
                </div>`, 
                GAME_DATA.maxLevel >= 100 ? `<button onclick="doReborn();closeModal()" class="w-full py-5 bg-indigo-600 rounded-2xl text-base font-black btn-click">åŸ·è¡Œè½‰ç”Ÿ</button>` : `<div class="text-xs text-red-500 font-black text-center w-full py-4">åœ°åŸéœ€é”åˆ° 100 å±¤æ‰èƒ½å•Ÿå‹•è¼ªè¿´</div>`
            );
        }

        // è¡Œç‚ºå‡½æ•¸
        function upStat(k) {
            if (GAME_DATA.gold >= GAME_DATA.costs[k]) {
                GAME_DATA.gold -= GAME_DATA.costs[k];
                GAME_DATA.stats[k]++; GAME_DATA.costs[k] = Math.floor(GAME_DATA.costs[k] * 1.35);
                updateStats(); updateUI(); switchTab(activeTab);
            } else toast("âŒ é¤˜é¡ä¸è¶³ä»¥æ”¯ä»˜åŸºå› æ”¹é€ ", "#ef4444");
        }

        function buyShop(id) {
            const it = SHOP_ITEMS.find(x => x.id === id);
            const lv = GAME_DATA.shopLv[id] || 0;
            const cost = it.baseCost + lv;
            if (GAME_DATA.rebornStones >= cost) {
                GAME_DATA.rebornStones -= cost;
                GAME_DATA.shopLv[id]++;
                updateStats(); updateUI(); switchTab(activeTab);
                toast("âœ¨ è–çŸ³å¼·åŒ–æˆåŠŸ", "#a855f7");
            } else toast("âŒ è–çŸ³æ•¸é‡ä¸è¶³", "#ef4444");
        }

        function doReborn() {
            const s = Math.floor(GAME_DATA.maxLevel / 10 * (1 + GAME_DATA.shopLv.rebP * 0.15));
            GAME_DATA.rebornStones += s; GAME_DATA.rebornCount++;
            GAME_DATA.level = 1; GAME_DATA.gold = 0; GAME_DATA.isTower = false; GAME_DATA.autoAdv = false;
            updateStats(); updateUI(); spawn();
        }

        function startTower() {
            GAME_DATA.isTower = true; GAME_DATA.towerFloor = 1; GAME_DATA.autoAdv = false;
            document.getElementById('battle-scene').style.backgroundColor = '#1e1b4b';
            updateUI(); spawn();
        }

        function equipInv(i) {
            const it = GAME_DATA.inv[i];
            const old = GAME_DATA.equips[it.idx];
            GAME_DATA.equips[it.idx] = it;
            GAME_DATA.inv.splice(i, 1);
            if (old && old.r === 'SET') GAME_DATA.inv.push(old);
            updateStats(); switchTab('bag');
            toast("âœ… æ›è£å®Œç•¢", "#22c55e");
        }

        function delInv(i) {
            GAME_DATA.inv.splice(i, 1);
            switchTab('bag');
            toast("ğŸ—‘ï¸ å¥—è£å·²åˆ†è§£", "#94a3b8");
        }

        function toggleAuto() { if (!GAME_DATA.isTower) { GAME_DATA.autoAdv = !GAME_DATA.autoAdv; updateUI(); } }
        function goBack() { if (!GAME_DATA.isTower && GAME_DATA.level > 1) { GAME_DATA.level--; GAME_DATA.autoAdv = false; spawn(); updateUI(); } }
        
        // UI æ›´æ–°å‡½æ•¸
        function updateUI() {
            document.getElementById('gold-display').innerText = formatNumber(GAME_DATA.gold);
            document.getElementById('zone-display').innerText = GAME_DATA.isTower ? `æ·±æ·µ ${GAME_DATA.towerFloor}F` : `åœ°åŸ Lv.${GAME_DATA.level}`;
            document.getElementById('mode-badge').innerText = GAME_DATA.isTower ? "å‰¯æœ¬æŒ‘æˆ°" : (GAME_DATA.autoAdv ? "è‡ªå‹•æ¢ç´¢" : "æ‰‹å‹•æŒ‘æˆ°");
            document.getElementById('reborn-status').innerText = `x${GAME_DATA.rebornCount}`;
            document.getElementById('auto-btn').innerText = `è‡ªå‹•: ${GAME_DATA.autoAdv ? 'ON' : 'OFF'}`;
            document.getElementById('auto-btn').style.background = GAME_DATA.autoAdv ? '#166534' : '';
        }

        function updatePlayerUI() {
            const p = (player.hp / player.maxHp) * 100;
            document.getElementById('player-hp-bar').style.width = p + "%";
            document.getElementById('player-hp-text').innerText = `${formatNumber(player.hp)} / ${formatNumber(player.maxHp)}`;
        }

        function updateEnemyUI() {
            const p = (enemy.hp / enemy.maxHp) * 100;
            document.getElementById('monster-hp-bar').style.width = p + "%";
        }

        function showDmg(a, c) {
            const el = document.createElement('div'); el.className = 'hit-effect';
            el.innerText = (c ? 'ğŸ”¥' : '') + formatNumber(a);
            const s = document.getElementById('battle-scene');
            const t = document.getElementById('monster-sprite').getBoundingClientRect();
            const r = s.getBoundingClientRect();
            el.style.left = (t.left - r.left + t.width/2 + (Math.random()*80-40)) + 'px';
            el.style.top = (t.top - r.top + 50) + 'px';
            s.appendChild(el); setTimeout(() => el.remove(), 800);
        }

        function toast(m, c) {
            const t = document.createElement('div');
            t.className = 'px-6 py-4 rounded-2xl text-sm font-black text-white shadow-2xl border-2 border-white/10 text-center animate-bounce';
            t.style.backgroundColor = c; t.innerText = m;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 2500);
        }

        function showModal(h, b, a) {
            document.getElementById('modal-header').innerHTML = h;
            document.getElementById('modal-body').innerHTML = b;
            document.getElementById('modal-action').innerHTML = a || "";
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveGame() { 
            GAME_DATA.lastSave = Date.now();
            localStorage.setItem(__app_id, JSON.stringify(GAME_DATA)); 
        }

        function loadGame() {
            const saved = localStorage.getItem(__app_id);
            if (saved) {
                const p = JSON.parse(saved);
                Object.keys(p).forEach(k => {
                    if (typeof p[k] === 'object' && !Array.isArray(p[k]) && p[k] !== null) Object.assign(GAME_DATA[k], p[k]);
                    else GAME_DATA[k] = p[k];
                });
            }
        }

        init();
    </script>
</body>
</html>
